<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.11"/>
<title>UM C API: Source code for lbmmontrlbm.c</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
  $(window).load(resizeHeight);
</script>
<link href="doxygen_api.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">UM C API
   &#160;<span id="projectnumber">6.12</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.11 -->
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li class="current"><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="annotated.html"><span>Data&#160;Structures</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
    </ul>
  </div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('lbmmontrlbm_c_page.html','');});
</script>
<div id="doc-content">
<div class="header">
  <div class="headertitle">
<div class="title">Source code for lbmmontrlbm.c </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><div class="fragment"><div class="line"><span class="comment">/*</span></div><div class="line"><span class="comment">  All of the documentation and software included in this and any</span></div><div class="line"><span class="comment">  other Informatica Corporation Ultra Messaging Releases</span></div><div class="line"><span class="comment">  Copyright (C) Informatica Corporation. All rights reserved.</span></div><div class="line"><span class="comment">  </span></div><div class="line"><span class="comment">  Redistribution and use in source and binary forms, with or without</span></div><div class="line"><span class="comment">  modification, are permitted only as covered by the terms of a</span></div><div class="line"><span class="comment">  valid software license agreement with Informatica Corporation.</span></div><div class="line"><span class="comment"></span></div><div class="line"><span class="comment">  Copyright (C) 2004-2019, Informatica Corporation. All Rights Reserved.</span></div><div class="line"><span class="comment"></span></div><div class="line"><span class="comment">  THE SOFTWARE IS PROVIDED &quot;AS IS&quot; AND INFORMATICA DISCLAIMS ALL WARRANTIES </span></div><div class="line"><span class="comment">  EXPRESS OR IMPLIED, INCLUDING WITHOUT LIMITATION, ANY IMPLIED WARRANTIES OF </span></div><div class="line"><span class="comment">  NON-INFRINGEMENT, MERCHANTABILITY OR FITNESS FOR A PARTICULAR </span></div><div class="line"><span class="comment">  PURPOSE.  INFORMATICA DOES NOT WARRANT THAT USE OF THE SOFTWARE WILL BE </span></div><div class="line"><span class="comment">  UNINTERRUPTED OR ERROR-FREE.  INFORMATICA SHALL NOT, UNDER ANY CIRCUMSTANCES, BE </span></div><div class="line"><span class="comment">  LIABLE TO LICENSEE FOR LOST PROFITS, CONSEQUENTIAL, INCIDENTAL, SPECIAL OR </span></div><div class="line"><span class="comment">  INDIRECT DAMAGES ARISING OUT OF OR RELATED TO THIS AGREEMENT OR THE </span></div><div class="line"><span class="comment">  TRANSACTIONS CONTEMPLATED HEREUNDER, EVEN IF INFORMATICA HAS BEEN APPRISED OF </span></div><div class="line"><span class="comment">  THE LIKELIHOOD OF SUCH DAMAGES.</span></div><div class="line"><span class="comment">  </span></div><div class="line"><span class="comment">*/</span></div><div class="line"></div><div class="line"><span class="preprocessor">#ifdef __VOS__</span></div><div class="line"><span class="preprocessor">#define _POSIX_C_SOURCE 200112L</span></div><div class="line"><span class="preprocessor">#include &lt;sys/time.h&gt;</span></div><div class="line"><span class="preprocessor">#endif</span></div><div class="line"></div><div class="line"><span class="preprocessor">#include &lt;stdio.h&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;time.h&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;string.h&gt;</span></div><div class="line"><span class="preprocessor">#ifdef _WIN32</span></div><div class="line"><span class="preprocessor">        #define strcasecmp stricmp</span></div><div class="line"><span class="preprocessor">        #define snprintf _snprintf</span></div><div class="line"><span class="preprocessor">#else</span></div><div class="line"><span class="preprocessor">        #include &quot;config.h&quot;</span></div><div class="line"><span class="preprocessor">        #include &lt;unistd.h&gt;</span></div><div class="line"><span class="preprocessor">        #if defined(__TANDEM)</span></div><div class="line"><span class="preprocessor">                #if defined(HAVE_TANDEM_SPT)</span></div><div class="line"><span class="preprocessor">                        #include &lt;ktdmtyp.h&gt;</span></div><div class="line"><span class="preprocessor">                        #include &lt;spthread.h&gt;</span></div><div class="line"><span class="preprocessor">                #else</span></div><div class="line"><span class="preprocessor">                        #include &lt;pthread.h&gt;</span></div><div class="line"><span class="preprocessor">                #endif</span></div><div class="line"><span class="preprocessor">        #else</span></div><div class="line"><span class="preprocessor">                #include &lt;pthread.h&gt;</span></div><div class="line"><span class="preprocessor">        #endif</span></div><div class="line"><span class="preprocessor">        #include &lt;strings.h&gt;</span></div><div class="line"><span class="preprocessor">#endif</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="lbmmon_8h.html">lbm/lbmmon.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;lbm/lbmmontrlbm.h&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="lbmaux_8h.html">lbm/lbmaux.h</a>&gt;</span></div><div class="line"></div><div class="line"><span class="comment">/*                                                                              </span></div><div class="line"><span class="comment">        Package all of the needed function pointers for this module into a</span></div><div class="line"><span class="comment">        lbmmon_transport_func_t structure.                                                                                                                                                              </span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="keyword">static</span> <span class="keyword">const</span> <a class="code" href="structlbmmon__transport__func__t__stct.html">lbmmon_transport_func_t</a> LBMMON_TRANSPORT_LBM =</div><div class="line">{</div><div class="line">        lbmmon_transport_lbm_initsrc,</div><div class="line">        lbmmon_transport_lbm_initrcv,</div><div class="line">        lbmmon_transport_lbm_send,</div><div class="line">        lbmmon_transport_lbm_receive,</div><div class="line">        lbmmon_transport_lbm_src_finish,</div><div class="line">        lbmmon_transport_lbm_rcv_finish,</div><div class="line">        lbmmon_transport_lbm_errmsg</div><div class="line">};</div><div class="line"></div><div class="line"><span class="comment">/*                                                                              </span></div><div class="line"><span class="comment">        For a statistics source, one of these gets returned as the TransportClientData.                                                                                                                                                         </span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span></div><div class="line">{</div><div class="line">        <span class="comment">/* LBM context attributes */</span></div><div class="line">        <a class="code" href="lbm_8h.html#acf249ec7a22d6a0eb9fc42d6375bda5a">lbm_context_attr_t</a> * mContextAttributes;</div><div class="line">        <span class="comment">/* LBM context created to send a statistics packet */</span></div><div class="line">        <a class="code" href="lbm_8h.html#a9f6ec97839a8f264eb4059de01174f3c">lbm_context_t</a> * mContext;</div><div class="line">        <span class="comment">/* LBM topic attributes */</span></div><div class="line">        <a class="code" href="lbm_8h.html#a30c33f443cf2d228f4772d534ce3ee88">lbm_src_topic_attr_t</a> * mTopicAttributes;</div><div class="line">        <span class="comment">/* LBM source created to send a statistics packet */</span></div><div class="line">        <a class="code" href="lbm_8h.html#a717ff27bb10ae7800330c21d810dffb8">lbm_src_t</a> * mSource;</div><div class="line">        <span class="comment">/* LBM topic */</span></div><div class="line">        <a class="code" href="lbm_8h.html#a3f0c8cba0e6f00fe7ae0ed717405e46d">lbm_topic_t</a> * mTopic;</div><div class="line">} lbmmon_transport_lbm_src_t;</div><div class="line"></div><div class="line"><span class="comment">/*</span></div><div class="line"><span class="comment">        A queue of incoming statistics packets is maintained. This describes each </span></div><div class="line"><span class="comment">        entry in the queue.</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="keyword">struct </span>lbmmon_transport_lbm_rcv_node_t_stct</div><div class="line">{</div><div class="line">        <span class="comment">/* Pointer to the LBM message */</span></div><div class="line">        <a class="code" href="structlbm__msg__t__stct.html">lbm_msg_t</a> * mMessage;</div><div class="line">        <span class="comment">/* Number of bytes of the message returned to caller */</span></div><div class="line">        <span class="keywordtype">size_t</span> mUsedBytes;</div><div class="line">        <span class="comment">/* Next entry in the queue */</span></div><div class="line">        <span class="keyword">struct </span>lbmmon_transport_lbm_rcv_node_t_stct * mNext;</div><div class="line">};</div><div class="line"><span class="keyword">typedef</span> <span class="keyword">struct </span>lbmmon_transport_lbm_rcv_node_t_stct lbmmon_transport_lbm_rcv_node_t;</div><div class="line"></div><div class="line"><span class="comment">/*                                                                              </span></div><div class="line"><span class="comment">        For a statistics receiver, one of these gets returned as the TransportClientData.                                                                                                                                                               </span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span></div><div class="line">{</div><div class="line">        <span class="comment">/* Flag to indicate lock has been created */</span></div><div class="line">        <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> mLockCreated;</div><div class="line">        <span class="comment">/* Lock to prevent access by multiple threads */</span></div><div class="line"><span class="preprocessor">#ifdef _WIN32</span></div><div class="line">        CRITICAL_SECTION mLock;</div><div class="line"><span class="preprocessor">#else</span></div><div class="line">        pthread_mutex_t mLock;</div><div class="line"><span class="preprocessor">#endif</span></div><div class="line">        <span class="comment">/* LBM context attributes */</span></div><div class="line">        <a class="code" href="lbm_8h.html#acf249ec7a22d6a0eb9fc42d6375bda5a">lbm_context_attr_t</a> * mContextAttributes;</div><div class="line">        <span class="comment">/* LBM context used to receive packets */</span></div><div class="line">        <a class="code" href="lbm_8h.html#a9f6ec97839a8f264eb4059de01174f3c">lbm_context_t</a> * mContext;</div><div class="line">        <span class="comment">/* LBM receiver used to receive packets */</span></div><div class="line">        <a class="code" href="lbm_8h.html#a0a4af6b8247cc5a0a24a8578fb6e83bd">lbm_rcv_t</a> * mReceiver;</div><div class="line">        <span class="comment">/* Topic attributes */</span></div><div class="line">        <a class="code" href="lbm_8h.html#af433822d81d21550902df6aacfc9d28d">lbm_rcv_topic_attr_t</a> * mTopicAttributes;</div><div class="line">        <span class="comment">/* Topic */</span></div><div class="line">        <a class="code" href="lbm_8h.html#a3f0c8cba0e6f00fe7ae0ed717405e46d">lbm_topic_t</a> * mTopic;</div><div class="line">        <span class="comment">/* Wildcard receiver attributes */</span></div><div class="line">        <a class="code" href="lbm_8h.html#afce0b32ac68ebedbdbcb775a5e7c2f8e">lbm_wildcard_rcv_attr_t</a> * mWildcardReceiverAttributes;</div><div class="line">        <span class="comment">/* If we&#39;re using a wildcard receiver... */</span></div><div class="line">        <a class="code" href="lbm_8h.html#a379731fbc3d8e9bcc40a7f070cf2e14b">lbm_wildcard_rcv_t</a> * mWildcardReceiver;</div><div class="line">        <span class="comment">/* Head of the message queue */</span></div><div class="line">        lbmmon_transport_lbm_rcv_node_t * mHead;</div><div class="line">        <span class="comment">/* Tail of the message queue */</span></div><div class="line">        lbmmon_transport_lbm_rcv_node_t * mTail;</div><div class="line">} lbmmon_transport_lbm_rcv_t;</div><div class="line"></div><div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span>     src_cleanup(lbmmon_transport_lbm_src_t * Data);</div><div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span>     rcv_cleanup(lbmmon_transport_lbm_rcv_t * Data);</div><div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span> receive_callback(<a class="code" href="lbm_8h.html#a0a4af6b8247cc5a0a24a8578fb6e83bd">lbm_rcv_t</a> * Receiver, <a class="code" href="structlbm__msg__t__stct.html">lbm_msg_t</a> * Message, <span class="keywordtype">void</span> * ClientData);</div><div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> lock_receiver(lbmmon_transport_lbm_rcv_t * Receiver);</div><div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> unlock_receiver(lbmmon_transport_lbm_rcv_t * Receiver);</div><div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span> scope_is_valid(<span class="keyword">const</span> <span class="keywordtype">char</span> * Scope);</div><div class="line"></div><div class="line"><span class="preprocessor">#define DEFAULT_CONTEXT_NAME &quot;29west_statistics_context&quot;</span></div><div class="line"><span class="preprocessor">#define DEFAULT_TOPIC &quot;/29west/statistics&quot;</span></div><div class="line"></div><div class="line"><span class="keyword">static</span> <span class="keywordtype">char</span> ErrorString[2048];</div><div class="line"></div><div class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span></div><div class="line">{</div><div class="line">        <span class="keyword">const</span> <span class="keywordtype">char</span> * option;</div><div class="line">        <span class="keyword">const</span> <span class="keywordtype">char</span> * value;</div><div class="line">} option_entry_t;</div><div class="line"></div><div class="line"><span class="keyword">static</span> option_entry_t SourceContextOption[] =</div><div class="line">{</div><div class="line">        <span class="comment">/* Force embedded mode for simplicity. */</span></div><div class="line">        { <span class="stringliteral">&quot;operational_mode&quot;</span>, <span class="stringliteral">&quot;embedded&quot;</span> },</div><div class="line">        <span class="comment">/* Disable monitoring for this context. */</span></div><div class="line">        { <span class="stringliteral">&quot;monitor_interval&quot;</span>, <span class="stringliteral">&quot;0&quot;</span> },</div><div class="line">        <span class="comment">/* We don&#39;t need request/response, so don&#39;t use up ports. */</span></div><div class="line">        { <span class="stringliteral">&quot;request_tcp_bind_request_port&quot;</span>, <span class="stringliteral">&quot;0&quot;</span> },</div><div class="line">        <span class="comment">/* We don&#39;t need MIM, so disable MIM receiver. */</span></div><div class="line">        { <span class="stringliteral">&quot;mim_incoming_address&quot;</span>, <span class="stringliteral">&quot;0.0.0.0&quot;</span> },</div><div class="line">        <span class="comment">/* No need to cache topics. */</span></div><div class="line">        { <span class="stringliteral">&quot;resolver_cache&quot;</span>, <span class="stringliteral">&quot;0&quot;</span> },</div><div class="line">        <span class="comment">/* End of list. */</span></div><div class="line">        { NULL, NULL }</div><div class="line">};</div><div class="line"></div><div class="line"><span class="keyword">static</span> option_entry_t ReceiverContextOption[] =</div><div class="line">{</div><div class="line">        <span class="comment">/* Force embedded mode for simplicity. */</span></div><div class="line">        { <span class="stringliteral">&quot;operational_mode&quot;</span>, <span class="stringliteral">&quot;embedded&quot;</span> },</div><div class="line">        <span class="comment">/* Disable monitoring for this context. */</span></div><div class="line">        { <span class="stringliteral">&quot;monitor_interval&quot;</span>, <span class="stringliteral">&quot;0&quot;</span> },</div><div class="line">        <span class="comment">/* We don&#39;t need request/response, so don&#39;t use up ports. */</span></div><div class="line">        { <span class="stringliteral">&quot;request_tcp_bind_request_port&quot;</span>, <span class="stringliteral">&quot;0&quot;</span> },</div><div class="line">        <span class="comment">/* We don&#39;t need MIM, so disable MIM receiver. */</span></div><div class="line">        { <span class="stringliteral">&quot;mim_incoming_address&quot;</span>, <span class="stringliteral">&quot;0.0.0.0&quot;</span> },</div><div class="line">        <span class="comment">/* No need to cache topics. */</span></div><div class="line">        { <span class="stringliteral">&quot;resolver_cache&quot;</span>, <span class="stringliteral">&quot;0&quot;</span> },</div><div class="line">        <span class="comment">/* End of list. */</span></div><div class="line">        { NULL, NULL }</div><div class="line">};</div><div class="line"></div><div class="line"><span class="keyword">static</span> option_entry_t SourceTopicOption[] =</div><div class="line">{</div><div class="line">        <span class="comment">/* Minimize memory used for LBT-RU retransmissions. */</span></div><div class="line">        { <span class="stringliteral">&quot;transport_lbtru_transmission_window_size&quot;</span>, <span class="stringliteral">&quot;500000&quot;</span> },</div><div class="line">        <span class="comment">/* Minimize memory used for LBT-RM retransmissions. */</span></div><div class="line">        { <span class="stringliteral">&quot;transport_lbtrm_transmission_window_size&quot;</span>, <span class="stringliteral">&quot;500000&quot;</span> },</div><div class="line">        <span class="comment">/* End of list. */</span></div><div class="line">        { NULL, NULL }</div><div class="line">};</div><div class="line"></div><div class="line"><span class="keyword">static</span> option_entry_t ReceiverTopicOption[] =</div><div class="line">{</div><div class="line">        <span class="comment">/* End of list. */</span></div><div class="line">        { NULL, NULL }</div><div class="line">};</div><div class="line"></div><div class="line"><span class="keyword">static</span> option_entry_t WildcardReceiverOption[] =</div><div class="line">{</div><div class="line">        <span class="comment">/* End of list. */</span></div><div class="line">        { NULL, NULL }</div><div class="line">};</div><div class="line"></div><div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> lbmmon_transport_lbm_report_allocation_error(<span class="keywordtype">size_t</span> Size)</div><div class="line">{</div><div class="line">        snprintf(ErrorString, <span class="keyword">sizeof</span>(ErrorString), <span class="stringliteral">&quot;Unable to allocate %u bytes&quot;</span>, (<span class="keywordtype">unsigned</span>) Size);</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keyword">const</span> <a class="code" href="structlbmmon__transport__func__t__stct.html">lbmmon_transport_func_t</a> *</div><div class="line">lbmmon_transport_lbm_module(<span class="keywordtype">void</span>)</div><div class="line">{</div><div class="line">        <span class="keywordflow">return</span> (&amp;LBMMON_TRANSPORT_LBM);</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keywordtype">int</span></div><div class="line">lbmmon_transport_lbm_initsrc(<span class="keywordtype">void</span> * * TransportClientData, <span class="keyword">const</span> <span class="keywordtype">void</span> * TransportOptions)</div><div class="line">{</div><div class="line">        lbmmon_transport_lbm_src_t * data;</div><div class="line">        <span class="keywordtype">int</span> rc;</div><div class="line">        <span class="keyword">const</span> <span class="keywordtype">char</span> * ptr = (<span class="keyword">const</span> <span class="keywordtype">char</span> *) TransportOptions;</div><div class="line">        <span class="keywordtype">char</span> key[512];</div><div class="line">        <span class="keywordtype">char</span> value[512];</div><div class="line">        <span class="keywordtype">char</span> config_file[512];</div><div class="line">        <span class="keywordtype">char</span> topic[512];</div><div class="line">        <span class="keywordtype">char</span> scope[512];</div><div class="line">        <span class="keywordtype">char</span> option[512];</div><div class="line">        option_entry_t * entry;</div><div class="line"></div><div class="line">        memset(ErrorString, 0, <span class="keyword">sizeof</span>(ErrorString));</div><div class="line">        data = malloc(<span class="keyword">sizeof</span>(lbmmon_transport_lbm_src_t));</div><div class="line">        <span class="keywordflow">if</span> (data == NULL)</div><div class="line">        {</div><div class="line">                lbmmon_transport_lbm_report_allocation_error(<span class="keyword">sizeof</span>(lbmmon_transport_lbm_src_t));</div><div class="line">                <span class="keywordflow">return</span> (-1);    </div><div class="line">        }</div><div class="line">        data-&gt;mContextAttributes = NULL;</div><div class="line">        data-&gt;mContext = NULL;</div><div class="line">        data-&gt;mTopicAttributes = NULL;</div><div class="line">        data-&gt;mSource = NULL;</div><div class="line">        data-&gt;mTopic = NULL;</div><div class="line"></div><div class="line">        <span class="comment">/* Process any options */</span></div><div class="line">        memset(config_file, 0, <span class="keyword">sizeof</span>(config_file));</div><div class="line">        strncpy(topic, DEFAULT_TOPIC, <span class="keyword">sizeof</span>(topic));</div><div class="line">        <span class="keywordflow">while</span> ((ptr = <a class="code" href="lbmmon_8h.html#ad10ac6fdaa7ba17b8efceca176c36070">lbmmon_next_key_value_pair</a>(ptr, key, <span class="keyword">sizeof</span>(key), value, <span class="keyword">sizeof</span>(value))) != NULL)</div><div class="line">        {</div><div class="line">                <span class="keywordflow">if</span> (strcasecmp(key, <span class="stringliteral">&quot;config&quot;</span>) == 0)</div><div class="line">                {</div><div class="line">                        strncpy(config_file, value, <span class="keyword">sizeof</span>(config_file));</div><div class="line">                }</div><div class="line">                <span class="keywordflow">else</span> <span class="keywordflow">if</span> (strcasecmp(key, <span class="stringliteral">&quot;topic&quot;</span>) == 0)</div><div class="line">                {</div><div class="line">                        strncpy(topic, value, <span class="keyword">sizeof</span>(topic));</div><div class="line">                }</div><div class="line">        }</div><div class="line"></div><div class="line">        <span class="comment">/* Initialize the context attributes */</span></div><div class="line">        rc = <a class="code" href="lbm_8h.html#a04c6b79859bc07f4cc6c9008242e77f7">lbm_context_attr_create_default</a>(&amp;(data-&gt;mContextAttributes));</div><div class="line">        <span class="keywordflow">if</span> (rc == LBM_FAILURE)</div><div class="line">        {</div><div class="line">                snprintf(ErrorString,</div><div class="line">                                 <span class="keyword">sizeof</span>(ErrorString),</div><div class="line">                                 <span class="stringliteral">&quot;lbm_context_attr_create() failed, %s&quot;</span>,</div><div class="line">                                 <a class="code" href="lbm_8h.html#a22a4650d3a5b649c84a0c05adedcc055">lbm_errmsg</a>());</div><div class="line">                <span class="keywordflow">return</span> (rc);</div><div class="line">        }</div><div class="line">        <span class="comment">/* Set the default context name */</span></div><div class="line">        rc = <a class="code" href="lbm_8h.html#af45c2cec5557da4057a0c96f305d6a40">lbm_context_attr_str_setopt</a>(data-&gt;mContextAttributes, <span class="stringliteral">&quot;context_name&quot;</span>, DEFAULT_CONTEXT_NAME);</div><div class="line">        <span class="keywordflow">if</span> (rc == LBM_FAILURE)</div><div class="line">        {</div><div class="line">                snprintf(ErrorString,</div><div class="line">                                 <span class="keyword">sizeof</span>(ErrorString),</div><div class="line">                                 <span class="stringliteral">&quot;lbm_context_attr_str_setopt() failed, %s&quot;</span>,</div><div class="line">                                 <a class="code" href="lbm_8h.html#a22a4650d3a5b649c84a0c05adedcc055">lbm_errmsg</a>());</div><div class="line">                <span class="keywordflow">return</span> (rc);</div><div class="line">        }</div><div class="line">        <span class="keywordflow">if</span> (config_file[0] != <span class="charliteral">&#39;\0&#39;</span>)</div><div class="line">        {</div><div class="line">                <span class="comment">/* A config file was passed as an option. Use it to populate the context attributes. */</span></div><div class="line">                rc = <a class="code" href="lbmaux_8h.html#ae7d92b1afb5b581a6b71a154448f89a7">lbmaux_context_attr_setopt_from_file</a>(data-&gt;mContextAttributes, config_file);</div><div class="line">                <span class="keywordflow">if</span> (rc != 0)</div><div class="line">                {</div><div class="line">                        snprintf(ErrorString,</div><div class="line">                                         <span class="keyword">sizeof</span>(ErrorString),</div><div class="line">                                         <span class="stringliteral">&quot;lbmaux_context_attr_setopt_from_file() failed, %s&quot;</span>,</div><div class="line">                                         <a class="code" href="lbm_8h.html#a22a4650d3a5b649c84a0c05adedcc055">lbm_errmsg</a>());</div><div class="line">                        src_cleanup(data);</div><div class="line">                        <span class="keywordflow">return</span> (-1);</div><div class="line">                }</div><div class="line">        }</div><div class="line">        <span class="comment">/* Go back through the options, looking for any specific context options. */</span></div><div class="line">        ptr = (<span class="keyword">const</span> <span class="keywordtype">char</span> *) TransportOptions;</div><div class="line">        <span class="keywordflow">while</span> ((ptr = <a class="code" href="lbmmon_8h.html#ad10ac6fdaa7ba17b8efceca176c36070">lbmmon_next_key_value_pair</a>(ptr, key, <span class="keyword">sizeof</span>(key), value, <span class="keyword">sizeof</span>(value))) != NULL)</div><div class="line">        {</div><div class="line">                <span class="keywordflow">if</span> (sscanf(key, <span class="stringliteral">&quot;%[a-zA-Z_]|%[a-zA-Z_]&quot;</span>, scope, option) != 2)</div><div class="line">                {</div><div class="line">                        <span class="keywordflow">continue</span>;</div><div class="line">                }</div><div class="line">                <span class="keywordflow">if</span> (scope_is_valid(scope) == -1)</div><div class="line">                {</div><div class="line">                        snprintf(ErrorString,</div><div class="line">                                         <span class="keyword">sizeof</span>(ErrorString),</div><div class="line">                                         <span class="stringliteral">&quot;invalid option scope [%s]&quot;</span>,</div><div class="line">                                         scope);</div><div class="line">                        src_cleanup(data);</div><div class="line">                        <span class="keywordflow">return</span> (-1);</div><div class="line">                }</div><div class="line">                <span class="keywordflow">if</span> (strcasecmp(scope, <span class="stringliteral">&quot;context&quot;</span>) == 0)</div><div class="line">                {</div><div class="line">                        rc = <a class="code" href="lbm_8h.html#af45c2cec5557da4057a0c96f305d6a40">lbm_context_attr_str_setopt</a>(data-&gt;mContextAttributes, option, value);</div><div class="line">                        <span class="keywordflow">if</span> (rc == LBM_FAILURE)</div><div class="line">                        {</div><div class="line">                                snprintf(ErrorString,</div><div class="line">                                                 <span class="keyword">sizeof</span>(ErrorString),</div><div class="line">                                                 <span class="stringliteral">&quot;invalid option [context %s %s], %s&quot;</span>,</div><div class="line">                                                 option,</div><div class="line">                                                 value,</div><div class="line">                                                 <a class="code" href="lbm_8h.html#a22a4650d3a5b649c84a0c05adedcc055">lbm_errmsg</a>());</div><div class="line">                                src_cleanup(data);</div><div class="line">                                <span class="keywordflow">return</span> (rc);</div><div class="line">                        }</div><div class="line">                }</div><div class="line">        }</div><div class="line"></div><div class="line">        entry = &amp;SourceContextOption[0];</div><div class="line">        <span class="keywordflow">while</span> (entry-&gt;option != NULL)</div><div class="line">        {</div><div class="line">                rc = <a class="code" href="lbm_8h.html#af45c2cec5557da4057a0c96f305d6a40">lbm_context_attr_str_setopt</a>(data-&gt;mContextAttributes, entry-&gt;option, entry-&gt;value);</div><div class="line">                <span class="keywordflow">if</span> (rc == LBM_FAILURE)</div><div class="line">                {</div><div class="line">                        snprintf(ErrorString,</div><div class="line">                                         <span class="keyword">sizeof</span>(ErrorString),</div><div class="line">                                         <span class="stringliteral">&quot;error setting option [context %s %s], %s&quot;</span>,</div><div class="line">                                         entry-&gt;option,</div><div class="line">                                         entry-&gt;value,</div><div class="line">                                         <a class="code" href="lbm_8h.html#a22a4650d3a5b649c84a0c05adedcc055">lbm_errmsg</a>());</div><div class="line">                        src_cleanup(data);</div><div class="line">                        <span class="keywordflow">return</span> (rc);</div><div class="line">                }</div><div class="line">                entry++;</div><div class="line">        }</div><div class="line"></div><div class="line">        <span class="comment">/* Create the context */</span></div><div class="line">        rc = <a class="code" href="lbm_8h.html#a8058947690bd0995bc2c59d4a61b462f">lbm_context_create</a>(&amp;(data-&gt;mContext), data-&gt;mContextAttributes, NULL, NULL);</div><div class="line">        <span class="keywordflow">if</span> (rc == LBM_FAILURE)</div><div class="line">        {</div><div class="line">                snprintf(ErrorString,</div><div class="line">                                 <span class="keyword">sizeof</span>(ErrorString),</div><div class="line">                                 <span class="stringliteral">&quot;lbm_context_create() failed, %s&quot;</span>,</div><div class="line">                                 <a class="code" href="lbm_8h.html#a22a4650d3a5b649c84a0c05adedcc055">lbm_errmsg</a>());</div><div class="line">                src_cleanup(data);</div><div class="line">                <span class="keywordflow">return</span> (rc);</div><div class="line">        }</div><div class="line"></div><div class="line">        <span class="comment">/* Initialize the source topic attributes */</span></div><div class="line">        rc = <a class="code" href="lbm_8h.html#ac299cf26605e18261b812a43012b1c24">lbm_src_topic_attr_create_default</a>(&amp;(data-&gt;mTopicAttributes));</div><div class="line">        <span class="keywordflow">if</span> (rc == LBM_FAILURE)</div><div class="line">        {</div><div class="line">                snprintf(ErrorString,</div><div class="line">                                 <span class="keyword">sizeof</span>(ErrorString),</div><div class="line">                                 <span class="stringliteral">&quot;lbm_src_topic_attr_create_default() failed, %s&quot;</span>,</div><div class="line">                                 <a class="code" href="lbm_8h.html#a22a4650d3a5b649c84a0c05adedcc055">lbm_errmsg</a>());</div><div class="line">                src_cleanup(data);</div><div class="line">                <span class="keywordflow">return</span> (rc);</div><div class="line">        }</div><div class="line">        entry = &amp;SourceTopicOption[0];</div><div class="line">        <span class="keywordflow">while</span> (entry-&gt;option != NULL)</div><div class="line">        {</div><div class="line">                rc = <a class="code" href="lbm_8h.html#a422f330bf7ef3efdd7a9f17caabccb24">lbm_src_topic_attr_str_setopt</a>(data-&gt;mTopicAttributes, entry-&gt;option, entry-&gt;value);</div><div class="line">                <span class="keywordflow">if</span> (rc == LBM_FAILURE)</div><div class="line">                {</div><div class="line">                        snprintf(ErrorString,</div><div class="line">                                         <span class="keyword">sizeof</span>(ErrorString),</div><div class="line">                                         <span class="stringliteral">&quot;error setting option [source %s %s], %s&quot;</span>,</div><div class="line">                                         entry-&gt;option,</div><div class="line">                                         entry-&gt;value,</div><div class="line">                                         <a class="code" href="lbm_8h.html#a22a4650d3a5b649c84a0c05adedcc055">lbm_errmsg</a>());</div><div class="line">                        src_cleanup(data);</div><div class="line">                        <span class="keywordflow">return</span> (rc);</div><div class="line">                }</div><div class="line">                entry++;</div><div class="line">        }</div><div class="line">        <span class="keywordflow">if</span> (config_file[0] != <span class="charliteral">&#39;\0&#39;</span>)</div><div class="line">        {</div><div class="line">                <span class="comment">/* A config file was passed as an option. Use it to populate the source topic attributes. */</span></div><div class="line">                rc = <a class="code" href="lbmaux_8h.html#a7edbb9615d48f272bd1754e66d480a0b">lbmaux_src_topic_attr_setopt_from_file</a>(data-&gt;mTopicAttributes, config_file);</div><div class="line">                <span class="keywordflow">if</span> (rc != 0)</div><div class="line">                {</div><div class="line">                        snprintf(ErrorString,</div><div class="line">                                         <span class="keyword">sizeof</span>(ErrorString),</div><div class="line">                                         <span class="stringliteral">&quot;lbmaux_src_topic_attr_setopt_from_file() failed, %s&quot;</span>,</div><div class="line">                                         <a class="code" href="lbm_8h.html#a22a4650d3a5b649c84a0c05adedcc055">lbm_errmsg</a>());</div><div class="line">                        src_cleanup(data);</div><div class="line">                        <span class="keywordflow">return</span> (-1);</div><div class="line">                }</div><div class="line">        }</div><div class="line">        <span class="comment">/* Go back through the options, looking for any specific source options. */</span></div><div class="line">        ptr = (<span class="keyword">const</span> <span class="keywordtype">char</span> *) TransportOptions;</div><div class="line">        <span class="keywordflow">while</span> ((ptr = <a class="code" href="lbmmon_8h.html#ad10ac6fdaa7ba17b8efceca176c36070">lbmmon_next_key_value_pair</a>(ptr, key, <span class="keyword">sizeof</span>(key), value, <span class="keyword">sizeof</span>(value))) != NULL)</div><div class="line">        {</div><div class="line">                <span class="keywordflow">if</span> (sscanf(key, <span class="stringliteral">&quot;%[a-zA-Z_]|%[a-zA-Z_]&quot;</span>, scope, option) != 2)</div><div class="line">                {</div><div class="line">                        <span class="keywordflow">continue</span>;</div><div class="line">                }</div><div class="line">                <span class="keywordflow">if</span> (strcasecmp(scope, <span class="stringliteral">&quot;source&quot;</span>) == 0)</div><div class="line">                {</div><div class="line">                        rc = <a class="code" href="lbm_8h.html#a422f330bf7ef3efdd7a9f17caabccb24">lbm_src_topic_attr_str_setopt</a>(data-&gt;mTopicAttributes, option, value);</div><div class="line">                        <span class="keywordflow">if</span> (rc == LBM_FAILURE)</div><div class="line">                        {</div><div class="line">                                snprintf(ErrorString,</div><div class="line">                                                 <span class="keyword">sizeof</span>(ErrorString),</div><div class="line">                                                 <span class="stringliteral">&quot;invalid option [source %s %s], %s&quot;</span>,</div><div class="line">                                                 option,</div><div class="line">                                                 value,</div><div class="line">                                                 <a class="code" href="lbm_8h.html#a22a4650d3a5b649c84a0c05adedcc055">lbm_errmsg</a>());</div><div class="line">                                src_cleanup(data);</div><div class="line">                                <span class="keywordflow">return</span> (rc);</div><div class="line">                        }</div><div class="line">                }</div><div class="line">        }</div><div class="line"></div><div class="line">        <span class="comment">/* Create the topic */</span></div><div class="line">        rc = <a class="code" href="lbm_8h.html#a1ba60407fa2bde0997aab6d5a5d2da1a">lbm_src_topic_alloc</a>(&amp;(data-&gt;mTopic), data-&gt;mContext, topic, data-&gt;mTopicAttributes);</div><div class="line">        <span class="keywordflow">if</span> (rc == LBM_FAILURE)</div><div class="line">        {</div><div class="line">                snprintf(ErrorString,</div><div class="line">                                 <span class="keyword">sizeof</span>(ErrorString),</div><div class="line">                                 <span class="stringliteral">&quot;lbm_src_topic_alloc() failed, %s&quot;</span>,</div><div class="line">                                 <a class="code" href="lbm_8h.html#a22a4650d3a5b649c84a0c05adedcc055">lbm_errmsg</a>());</div><div class="line">                src_cleanup(data);</div><div class="line">                <span class="keywordflow">return</span> (rc);</div><div class="line">        }</div><div class="line"></div><div class="line">        <span class="comment">/* Create the source */</span></div><div class="line">        rc = <a class="code" href="lbm_8h.html#ab8dd76271bf9df7a5f88476d431f523e">lbm_src_create</a>(&amp;(data-&gt;mSource), data-&gt;mContext, data-&gt;mTopic, NULL, NULL, NULL);</div><div class="line">        <span class="keywordflow">if</span> (rc == LBM_FAILURE)</div><div class="line">        {</div><div class="line">                snprintf(ErrorString,</div><div class="line">                                 <span class="keyword">sizeof</span>(ErrorString),</div><div class="line">                                 <span class="stringliteral">&quot;lbm_src_create() failed, %s&quot;</span>,</div><div class="line">                                 <a class="code" href="lbm_8h.html#a22a4650d3a5b649c84a0c05adedcc055">lbm_errmsg</a>());</div><div class="line">                src_cleanup(data);</div><div class="line">                <span class="keywordflow">return</span> (rc);</div><div class="line">        }</div><div class="line"></div><div class="line">        <span class="comment">/* Pass back the lbmmon_transport_lbm_src_t created */</span></div><div class="line">        *TransportClientData = data;</div><div class="line">        <span class="keywordflow">return</span> (0);</div><div class="line">}</div><div class="line"></div><div class="line"><span class="comment">/*                                                                              </span></div><div class="line"><span class="comment">        This function is called upon receipt of an LBM message (when operating as</span></div><div class="line"><span class="comment">        a statistics receiver).                                                                                                                                                         </span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="keywordtype">int</span></div><div class="line">receive_callback(<a class="code" href="lbm_8h.html#a0a4af6b8247cc5a0a24a8578fb6e83bd">lbm_rcv_t</a> * Receiver, <a class="code" href="structlbm__msg__t__stct.html">lbm_msg_t</a> * Message, <span class="keywordtype">void</span> * ClientData)</div><div class="line">{</div><div class="line">        lbmmon_transport_lbm_rcv_t * rcv = (lbmmon_transport_lbm_rcv_t *) ClientData;</div><div class="line">        lbmmon_transport_lbm_rcv_node_t * node;</div><div class="line"></div><div class="line">        <span class="keywordflow">if</span> (Message-&gt;<a class="code" href="structlbm__msg__t__stct.html#ab25327dc4b4ebf527106f6e708dbc05f">type</a> == <a class="code" href="lbm_8h.html#aa47eb604db7dc9fd53f9650ed940e058">LBM_MSG_DATA</a>)</div><div class="line">        {</div><div class="line">                <span class="comment">/* A data message. We want to enqueue it for processing. */</span></div><div class="line">                lock_receiver(rcv);</div><div class="line">                node = malloc(<span class="keyword">sizeof</span>(lbmmon_transport_lbm_rcv_node_t));</div><div class="line">                <span class="keywordflow">if</span> (node == NULL)</div><div class="line">                {</div><div class="line">                        lbmmon_transport_lbm_report_allocation_error(<span class="keyword">sizeof</span>(lbmmon_transport_lbm_rcv_node_t));</div><div class="line">                        <span class="keywordflow">return</span> (-1);    </div><div class="line">                }</div><div class="line">                <span class="comment">/*</span></div><div class="line"><span class="comment">                        Since we hold onto the message until it is actually processed,</span></div><div class="line"><span class="comment">                        let LBM know about it.</span></div><div class="line"><span class="comment">                */</span></div><div class="line">                <a class="code" href="lbm_8h.html#a2b7788ff58f9e78bc89ea890dad0cccf">lbm_msg_retain</a>(Message);</div><div class="line">                node-&gt;mMessage = Message;</div><div class="line">                node-&gt;mUsedBytes = 0;   <span class="comment">/* No data returned as yet */</span></div><div class="line"></div><div class="line">                <span class="comment">/* Link the message onto the queue */</span></div><div class="line">                node-&gt;mNext = NULL;</div><div class="line">                <span class="keywordflow">if</span> (rcv-&gt;mTail != NULL)</div><div class="line">                {</div><div class="line">                        rcv-&gt;mTail-&gt;mNext = node;</div><div class="line">                }</div><div class="line">                <span class="keywordflow">else</span></div><div class="line">                {</div><div class="line">                        rcv-&gt;mHead = node;</div><div class="line">                }</div><div class="line">                rcv-&gt;mTail = node;</div><div class="line">                unlock_receiver(rcv);</div><div class="line">        }</div><div class="line">        <span class="keywordflow">return</span> (0);</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keywordtype">int</span></div><div class="line">lbmmon_transport_lbm_initrcv(<span class="keywordtype">void</span> * * TransportClientData, <span class="keyword">const</span> <span class="keywordtype">void</span> * TransportOptions)</div><div class="line">{</div><div class="line">        lbmmon_transport_lbm_rcv_t * data;</div><div class="line">        <span class="keywordtype">int</span> rc;</div><div class="line">        <span class="keyword">const</span> <span class="keywordtype">char</span> * ptr = (<span class="keyword">const</span> <span class="keywordtype">char</span> *) TransportOptions;</div><div class="line">        <span class="keywordtype">char</span> key[512];</div><div class="line">        <span class="keywordtype">char</span> value[512];</div><div class="line">        <span class="keywordtype">char</span> config_file[512];</div><div class="line">        <span class="keywordtype">char</span> topic[512];</div><div class="line">        <span class="keywordtype">char</span> wildcard_topic[512];</div><div class="line">        <span class="keywordtype">char</span> scope[512];</div><div class="line">        <span class="keywordtype">char</span> option[512];</div><div class="line">        option_entry_t * entry;</div><div class="line"></div><div class="line">        memset(ErrorString, 0, <span class="keyword">sizeof</span>(ErrorString));</div><div class="line">        data = malloc(<span class="keyword">sizeof</span>(lbmmon_transport_lbm_rcv_t));</div><div class="line">        <span class="keywordflow">if</span> (data == NULL)</div><div class="line">        {</div><div class="line">                lbmmon_transport_lbm_report_allocation_error(<span class="keyword">sizeof</span>(lbmmon_transport_lbm_rcv_t));</div><div class="line">                <span class="keywordflow">return</span> (-1);    </div><div class="line">        }</div><div class="line"></div><div class="line">        data-&gt;mLockCreated = 0;</div><div class="line">        data-&gt;mContextAttributes = NULL;</div><div class="line">        data-&gt;mContext = NULL;</div><div class="line">        data-&gt;mReceiver = NULL;</div><div class="line">        data-&gt;mTopicAttributes = NULL;</div><div class="line">        data-&gt;mTopic = NULL;</div><div class="line">        data-&gt;mWildcardReceiverAttributes = NULL;</div><div class="line">        data-&gt;mWildcardReceiver = NULL;</div><div class="line">        data-&gt;mHead = NULL;</div><div class="line">        data-&gt;mTail = NULL;</div><div class="line"></div><div class="line">        <span class="comment">/* Process any options */</span></div><div class="line">        memset(config_file, 0, <span class="keyword">sizeof</span>(config_file));</div><div class="line">        strncpy(topic, DEFAULT_TOPIC, <span class="keyword">sizeof</span>(topic));</div><div class="line">        memset(wildcard_topic, 0, <span class="keyword">sizeof</span>(wildcard_topic));</div><div class="line">        <span class="keywordflow">while</span> ((ptr = <a class="code" href="lbmmon_8h.html#ad10ac6fdaa7ba17b8efceca176c36070">lbmmon_next_key_value_pair</a>(ptr, key, <span class="keyword">sizeof</span>(key), value, <span class="keyword">sizeof</span>(value))) != NULL)</div><div class="line">        {</div><div class="line">                <span class="keywordflow">if</span> (strcasecmp(key, <span class="stringliteral">&quot;config&quot;</span>) == 0)</div><div class="line">                {</div><div class="line">                        strncpy(config_file, value, <span class="keyword">sizeof</span>(config_file));</div><div class="line">                }</div><div class="line">                <span class="keywordflow">else</span> <span class="keywordflow">if</span> (strcasecmp(key, <span class="stringliteral">&quot;topic&quot;</span>) == 0)</div><div class="line">                {</div><div class="line">                        strncpy(topic, value, <span class="keyword">sizeof</span>(topic));</div><div class="line">                }</div><div class="line">                <span class="keywordflow">else</span> <span class="keywordflow">if</span> (strcasecmp(key, <span class="stringliteral">&quot;wctopic&quot;</span>) == 0)</div><div class="line">                {</div><div class="line">                        strncpy(wildcard_topic, value, <span class="keyword">sizeof</span>(wildcard_topic));</div><div class="line">                }</div><div class="line">        }</div><div class="line"></div><div class="line">        <span class="comment">/* Initialize the context attributes */</span></div><div class="line">        rc = <a class="code" href="lbm_8h.html#a04c6b79859bc07f4cc6c9008242e77f7">lbm_context_attr_create_default</a>(&amp;(data-&gt;mContextAttributes));</div><div class="line">        <span class="keywordflow">if</span> (rc == LBM_FAILURE)</div><div class="line">        {</div><div class="line">                snprintf(ErrorString,</div><div class="line">                                 <span class="keyword">sizeof</span>(ErrorString),</div><div class="line">                                 <span class="stringliteral">&quot;lbm_context_attr_create() failed, %s&quot;</span>,</div><div class="line">                                 <a class="code" href="lbm_8h.html#a22a4650d3a5b649c84a0c05adedcc055">lbm_errmsg</a>());</div><div class="line">                rcv_cleanup(data);</div><div class="line">                <span class="keywordflow">return</span> (rc);</div><div class="line">        }</div><div class="line">        <span class="comment">/* Set the default context name */</span></div><div class="line">        rc = <a class="code" href="lbm_8h.html#af45c2cec5557da4057a0c96f305d6a40">lbm_context_attr_str_setopt</a>(data-&gt;mContextAttributes, <span class="stringliteral">&quot;context_name&quot;</span>, DEFAULT_CONTEXT_NAME);</div><div class="line">        <span class="keywordflow">if</span> (rc == LBM_FAILURE)</div><div class="line">        {</div><div class="line">                snprintf(ErrorString,</div><div class="line">                                 <span class="keyword">sizeof</span>(ErrorString),</div><div class="line">                                 <span class="stringliteral">&quot;lbm_context_attr_str_setopt() failed, %s&quot;</span>,</div><div class="line">                                 <a class="code" href="lbm_8h.html#a22a4650d3a5b649c84a0c05adedcc055">lbm_errmsg</a>());</div><div class="line">                <span class="keywordflow">return</span> (rc);</div><div class="line">        }</div><div class="line">        <span class="keywordflow">if</span> (config_file[0] != <span class="charliteral">&#39;\0&#39;</span>)</div><div class="line">        {</div><div class="line">                <span class="comment">/* A config file was passed as an option. Use it to populate the context attributes. */</span></div><div class="line">                rc = <a class="code" href="lbmaux_8h.html#ae7d92b1afb5b581a6b71a154448f89a7">lbmaux_context_attr_setopt_from_file</a>(data-&gt;mContextAttributes, config_file);</div><div class="line">                <span class="keywordflow">if</span> (rc != 0)</div><div class="line">                {</div><div class="line">                        snprintf(ErrorString,</div><div class="line">                                         <span class="keyword">sizeof</span>(ErrorString),</div><div class="line">                                         <span class="stringliteral">&quot;lbmaux_context_attr_setopt_from_file() failed, %s&quot;</span>,</div><div class="line">                                         <a class="code" href="lbm_8h.html#a22a4650d3a5b649c84a0c05adedcc055">lbm_errmsg</a>());</div><div class="line">                        rcv_cleanup(data);</div><div class="line">                        <span class="keywordflow">return</span> (-1);</div><div class="line">                }</div><div class="line">        }</div><div class="line">        <span class="comment">/* Go back through the options, looking for any specific context options. */</span></div><div class="line">        ptr = (<span class="keyword">const</span> <span class="keywordtype">char</span> *) TransportOptions;</div><div class="line">        <span class="keywordflow">while</span> ((ptr = <a class="code" href="lbmmon_8h.html#ad10ac6fdaa7ba17b8efceca176c36070">lbmmon_next_key_value_pair</a>(ptr, key, <span class="keyword">sizeof</span>(key), value, <span class="keyword">sizeof</span>(value))) != NULL)</div><div class="line">        {</div><div class="line">                <span class="keywordflow">if</span> (sscanf(key, <span class="stringliteral">&quot;%[a-zA-Z_]|%[a-zA-Z_]&quot;</span>, scope, option) != 2)</div><div class="line">                {</div><div class="line">                        <span class="keywordflow">continue</span>;</div><div class="line">                }</div><div class="line">                <span class="keywordflow">if</span> (scope_is_valid(scope) == -1)</div><div class="line">                {</div><div class="line">                        snprintf(ErrorString,</div><div class="line">                                         <span class="keyword">sizeof</span>(ErrorString),</div><div class="line">                                         <span class="stringliteral">&quot;invalid option scope [%s]&quot;</span>,</div><div class="line">                                         scope);</div><div class="line">                        rcv_cleanup(data);</div><div class="line">                        <span class="keywordflow">return</span> (-1);</div><div class="line">                }</div><div class="line">                <span class="keywordflow">if</span> (strcasecmp(scope, <span class="stringliteral">&quot;context&quot;</span>) == 0)</div><div class="line">                {</div><div class="line">                        rc = <a class="code" href="lbm_8h.html#af45c2cec5557da4057a0c96f305d6a40">lbm_context_attr_str_setopt</a>(data-&gt;mContextAttributes, option, value);</div><div class="line">                        <span class="keywordflow">if</span> (rc == LBM_FAILURE)</div><div class="line">                        {</div><div class="line">                                snprintf(ErrorString,</div><div class="line">                                                 <span class="keyword">sizeof</span>(ErrorString),</div><div class="line">                                                 <span class="stringliteral">&quot;invalid option [context %s %s], %s&quot;</span>,</div><div class="line">                                                 option,</div><div class="line">                                                 value,</div><div class="line">                                                 <a class="code" href="lbm_8h.html#a22a4650d3a5b649c84a0c05adedcc055">lbm_errmsg</a>());</div><div class="line">                                rcv_cleanup(data);</div><div class="line">                                <span class="keywordflow">return</span> (rc);</div><div class="line">                        }</div><div class="line">                }</div><div class="line">        }</div><div class="line"></div><div class="line">        entry = &amp;ReceiverContextOption[0];</div><div class="line">        <span class="keywordflow">while</span> (entry-&gt;option != NULL)</div><div class="line">        {               </div><div class="line">                rc = <a class="code" href="lbm_8h.html#af45c2cec5557da4057a0c96f305d6a40">lbm_context_attr_str_setopt</a>(data-&gt;mContextAttributes, entry-&gt;option, entry-&gt;value);</div><div class="line">                <span class="keywordflow">if</span> (rc == LBM_FAILURE)</div><div class="line">                {</div><div class="line">                        snprintf(ErrorString,</div><div class="line">                                         <span class="keyword">sizeof</span>(ErrorString),</div><div class="line">                                         <span class="stringliteral">&quot;error setting option [context %s %s], %s&quot;</span>,</div><div class="line">                                         entry-&gt;option,</div><div class="line">                                         entry-&gt;value,</div><div class="line">                                         <a class="code" href="lbm_8h.html#a22a4650d3a5b649c84a0c05adedcc055">lbm_errmsg</a>());</div><div class="line">                        rcv_cleanup(data);</div><div class="line">                        <span class="keywordflow">return</span> (rc);</div><div class="line">                }</div><div class="line">                entry++;</div><div class="line">        }</div><div class="line"></div><div class="line">        <span class="comment">/* Resolver cache need to enabled for wildcard receiver to work */</span></div><div class="line">        <span class="keywordflow">if</span> (wildcard_topic[0] != <span class="charliteral">&#39;\0&#39;</span>) </div><div class="line">        {</div><div class="line">                rc = <a class="code" href="lbm_8h.html#af45c2cec5557da4057a0c96f305d6a40">lbm_context_attr_str_setopt</a>(data-&gt;mContextAttributes, <span class="stringliteral">&quot;resolver_cache&quot;</span>, <span class="stringliteral">&quot;1&quot;</span>);</div><div class="line">                <span class="keywordflow">if</span> (rc == LBM_FAILURE)</div><div class="line">                {</div><div class="line">                        snprintf(ErrorString,</div><div class="line">                                         <span class="keyword">sizeof</span>(ErrorString),</div><div class="line">                                         <span class="stringliteral">&quot;error setting option [context %s %s], %s&quot;</span>,</div><div class="line">                                         <span class="stringliteral">&quot;resolver_cache&quot;</span>,</div><div class="line">                                         <span class="stringliteral">&quot;1&quot;</span>,</div><div class="line">                                         <a class="code" href="lbm_8h.html#a22a4650d3a5b649c84a0c05adedcc055">lbm_errmsg</a>());</div><div class="line">                        rcv_cleanup(data);</div><div class="line">                        <span class="keywordflow">return</span> (rc);</div><div class="line">                }</div><div class="line">        }</div><div class="line">        <span class="comment">/* Create the context */</span></div><div class="line">        rc = <a class="code" href="lbm_8h.html#a8058947690bd0995bc2c59d4a61b462f">lbm_context_create</a>(&amp;(data-&gt;mContext), data-&gt;mContextAttributes, NULL, NULL);</div><div class="line">        <span class="keywordflow">if</span> (rc == LBM_FAILURE)</div><div class="line">        {</div><div class="line">                snprintf(ErrorString,</div><div class="line">                                 <span class="keyword">sizeof</span>(ErrorString),</div><div class="line">                                 <span class="stringliteral">&quot;lbm_context_create() failed, %s&quot;</span>,</div><div class="line">                                 <a class="code" href="lbm_8h.html#a22a4650d3a5b649c84a0c05adedcc055">lbm_errmsg</a>());</div><div class="line">                rcv_cleanup(data);</div><div class="line">                <span class="keywordflow">return</span> (rc);</div><div class="line">        }</div><div class="line"></div><div class="line">        <span class="comment">/* If a wildcard topic was specified, initialize the wildcard receiver attributes. */</span></div><div class="line">        <span class="keywordflow">if</span> (wildcard_topic[0] != <span class="charliteral">&#39;\0&#39;</span>)</div><div class="line">        {</div><div class="line">                rc = <a class="code" href="lbm_8h.html#a5ebb6c37e8e27a5338bc786f10c05007">lbm_wildcard_rcv_attr_create_default</a>(&amp;(data-&gt;mWildcardReceiverAttributes));</div><div class="line">                <span class="keywordflow">if</span> (rc == LBM_FAILURE)</div><div class="line">                {</div><div class="line">                        snprintf(ErrorString,</div><div class="line">                                         <span class="keyword">sizeof</span>(ErrorString),</div><div class="line">                                         <span class="stringliteral">&quot;lbm_wildcard_rcv_attr_init() failed, %s&quot;</span>,</div><div class="line">                                         <a class="code" href="lbm_8h.html#a22a4650d3a5b649c84a0c05adedcc055">lbm_errmsg</a>());</div><div class="line">                        rcv_cleanup(data);</div><div class="line">                        <span class="keywordflow">return</span> (rc);</div><div class="line">                }</div><div class="line">                <span class="keywordflow">if</span> (config_file[0] != <span class="charliteral">&#39;\0&#39;</span>)</div><div class="line">                {</div><div class="line">                        <span class="comment">/* A config file was passed as an option. Use it to populate the wildcard receiver attributes. */</span></div><div class="line">                        rc = <a class="code" href="lbmaux_8h.html#a4427d2383bf4d2631ea2aa79e625bea1">lbmaux_wildcard_rcv_attr_setopt_from_file</a>(data-&gt;mWildcardReceiverAttributes, config_file);</div><div class="line">                        <span class="keywordflow">if</span> (rc == LBM_FAILURE)</div><div class="line">                        {</div><div class="line">                                snprintf(ErrorString,</div><div class="line">                                                 <span class="keyword">sizeof</span>(ErrorString),</div><div class="line">                                                 <span class="stringliteral">&quot;lbmaux_wildcard_rcv_attr_setopt_from_file() failed, %s&quot;</span>,</div><div class="line">                                                 <a class="code" href="lbm_8h.html#a22a4650d3a5b649c84a0c05adedcc055">lbm_errmsg</a>());</div><div class="line">                                rcv_cleanup(data);</div><div class="line">                                <span class="keywordflow">return</span> (-1);</div><div class="line">                        }</div><div class="line">                }</div><div class="line">                <span class="comment">/* Go back through the options, looking for any specific wildcard receiver options. */</span></div><div class="line">                ptr = (<span class="keyword">const</span> <span class="keywordtype">char</span> *) TransportOptions;</div><div class="line">                <span class="keywordflow">while</span> ((ptr = <a class="code" href="lbmmon_8h.html#ad10ac6fdaa7ba17b8efceca176c36070">lbmmon_next_key_value_pair</a>(ptr, key, <span class="keyword">sizeof</span>(key), value, <span class="keyword">sizeof</span>(value))) != NULL)</div><div class="line">                {</div><div class="line">                        <span class="keywordflow">if</span> (sscanf(key, <span class="stringliteral">&quot;%[a-zA-Z_]|%[a-zA-Z_]&quot;</span>, scope, option) != 2)</div><div class="line">                        {</div><div class="line">                                <span class="keywordflow">continue</span>;</div><div class="line">                        }</div><div class="line">                        <span class="keywordflow">if</span> (strcasecmp(scope, <span class="stringliteral">&quot;wildcard_receiver&quot;</span>) == 0)</div><div class="line">                        {</div><div class="line">                                rc = <a class="code" href="lbm_8h.html#acee962d050b7c17a8e92445612d7b404">lbm_wildcard_rcv_attr_str_setopt</a>(data-&gt;mWildcardReceiverAttributes, option, value);</div><div class="line">                                <span class="keywordflow">if</span> (rc == LBM_FAILURE)</div><div class="line">                                {</div><div class="line">                                        snprintf(ErrorString,</div><div class="line">                                                         <span class="keyword">sizeof</span>(ErrorString),</div><div class="line">                                                         <span class="stringliteral">&quot;invalid option [wildcard_receiver %s %s], %s&quot;</span>,</div><div class="line">                                                         option,</div><div class="line">                                                         value,</div><div class="line">                                                         <a class="code" href="lbm_8h.html#a22a4650d3a5b649c84a0c05adedcc055">lbm_errmsg</a>());</div><div class="line">                                        rcv_cleanup(data);</div><div class="line">                                        <span class="keywordflow">return</span> (rc);</div><div class="line">                                }</div><div class="line">                        }</div><div class="line">                }</div><div class="line">                entry = &amp;WildcardReceiverOption[0];</div><div class="line">                <span class="keywordflow">while</span> (entry-&gt;option != NULL)</div><div class="line">                {</div><div class="line">                        rc = <a class="code" href="lbm_8h.html#acee962d050b7c17a8e92445612d7b404">lbm_wildcard_rcv_attr_str_setopt</a>(data-&gt;mWildcardReceiverAttributes, entry-&gt;option, entry-&gt;value);</div><div class="line">                        <span class="keywordflow">if</span> (rc == LBM_FAILURE)</div><div class="line">                        {</div><div class="line">                                snprintf(ErrorString,</div><div class="line">                                                 <span class="keyword">sizeof</span>(ErrorString),</div><div class="line">                                                 <span class="stringliteral">&quot;error setting option [wildcard_receiver %s %s], %s&quot;</span>,</div><div class="line">                                                 entry-&gt;option,</div><div class="line">                                                 entry-&gt;value,</div><div class="line">                                                 <a class="code" href="lbm_8h.html#a22a4650d3a5b649c84a0c05adedcc055">lbm_errmsg</a>());</div><div class="line">                                rcv_cleanup(data);</div><div class="line">                                <span class="keywordflow">return</span> (rc);</div><div class="line">                        }</div><div class="line">                        entry++;</div><div class="line">                }</div><div class="line">        }</div><div class="line"></div><div class="line">        <span class="comment">/* Initialize and set the receiver topic attributes. */</span></div><div class="line">        rc = <a class="code" href="lbm_8h.html#aa0b62bc911b175ff51236ecf101d0d93">lbm_rcv_topic_attr_create_default</a>(&amp;(data-&gt;mTopicAttributes));</div><div class="line">        <span class="keywordflow">if</span> (rc == LBM_FAILURE)</div><div class="line">        {</div><div class="line">                snprintf(ErrorString,</div><div class="line">                                 <span class="keyword">sizeof</span>(ErrorString),</div><div class="line">                                 <span class="stringliteral">&quot;lbm_rcv_topic_attr_init() failed, %s&quot;</span>,</div><div class="line">                                 <a class="code" href="lbm_8h.html#a22a4650d3a5b649c84a0c05adedcc055">lbm_errmsg</a>());</div><div class="line">                rcv_cleanup(data);</div><div class="line">                <span class="keywordflow">return</span> (rc);</div><div class="line">        }</div><div class="line">        <span class="keywordflow">if</span> (config_file[0] != <span class="charliteral">&#39;\0&#39;</span>)</div><div class="line">        {</div><div class="line">                <span class="comment">/* A config file was passed as an option. Use it to populate the receiver topic attributes. */</span></div><div class="line">                rc = <a class="code" href="lbmaux_8h.html#a5c6d7294c9f3dfd3e1ef78d00fa927a3">lbmaux_rcv_topic_attr_setopt_from_file</a>(data-&gt;mTopicAttributes, config_file);</div><div class="line">                <span class="keywordflow">if</span> (rc == LBM_FAILURE)</div><div class="line">                {</div><div class="line">                        snprintf(ErrorString,</div><div class="line">                                         <span class="keyword">sizeof</span>(ErrorString),</div><div class="line">                                         <span class="stringliteral">&quot;lbmaux_rcv_topic_attr_setopt_from_file() failed, %s&quot;</span>,</div><div class="line">                                         <a class="code" href="lbm_8h.html#a22a4650d3a5b649c84a0c05adedcc055">lbm_errmsg</a>());</div><div class="line">                        rcv_cleanup(data);</div><div class="line">                        <span class="keywordflow">return</span> (-1);</div><div class="line">                }</div><div class="line">        }</div><div class="line">        <span class="comment">/* Go back through the options, looking for any specific receiver options. */</span></div><div class="line">        ptr = (<span class="keyword">const</span> <span class="keywordtype">char</span> *) TransportOptions;</div><div class="line">        <span class="keywordflow">while</span> ((ptr = <a class="code" href="lbmmon_8h.html#ad10ac6fdaa7ba17b8efceca176c36070">lbmmon_next_key_value_pair</a>(ptr, key, <span class="keyword">sizeof</span>(key), value, <span class="keyword">sizeof</span>(value))) != NULL)</div><div class="line">        {</div><div class="line">                <span class="keywordflow">if</span> (sscanf(key, <span class="stringliteral">&quot;%[a-zA-Z_]|%[a-zA-Z_]&quot;</span>, scope, option) != 2)</div><div class="line">                {</div><div class="line">                        <span class="keywordflow">continue</span>;</div><div class="line">                }</div><div class="line">                <span class="keywordflow">if</span> (strcasecmp(scope, <span class="stringliteral">&quot;receiver&quot;</span>) == 0)</div><div class="line">                {</div><div class="line">                        rc = <a class="code" href="lbm_8h.html#afabe075e34f7f712f09f710df87d9164">lbm_rcv_topic_attr_str_setopt</a>(data-&gt;mTopicAttributes, option, value);</div><div class="line">                        <span class="keywordflow">if</span> (rc == LBM_FAILURE)</div><div class="line">                        {</div><div class="line">                                snprintf(ErrorString,</div><div class="line">                                                 <span class="keyword">sizeof</span>(ErrorString),</div><div class="line">                                                 <span class="stringliteral">&quot;invalid option [receiver %s %s], %s&quot;</span>,</div><div class="line">                                                 option,</div><div class="line">                                                 value,</div><div class="line">                                                 <a class="code" href="lbm_8h.html#a22a4650d3a5b649c84a0c05adedcc055">lbm_errmsg</a>());</div><div class="line">                                rcv_cleanup(data);</div><div class="line">                                <span class="keywordflow">return</span> (rc);</div><div class="line">                        }</div><div class="line">                }</div><div class="line">        }</div><div class="line">        entry = &amp;ReceiverTopicOption[0];</div><div class="line">        <span class="keywordflow">while</span> (entry-&gt;option != NULL)</div><div class="line">        {</div><div class="line">                rc = <a class="code" href="lbm_8h.html#afabe075e34f7f712f09f710df87d9164">lbm_rcv_topic_attr_str_setopt</a>(data-&gt;mTopicAttributes, entry-&gt;option, entry-&gt;value);</div><div class="line">                <span class="keywordflow">if</span> (rc == LBM_FAILURE)</div><div class="line">                {</div><div class="line">                        snprintf(ErrorString,</div><div class="line">                                         <span class="keyword">sizeof</span>(ErrorString),</div><div class="line">                                         <span class="stringliteral">&quot;error setting option [receiver %s %s], %s&quot;</span>,</div><div class="line">                                         entry-&gt;option,</div><div class="line">                                         entry-&gt;value,</div><div class="line">                                         <a class="code" href="lbm_8h.html#a22a4650d3a5b649c84a0c05adedcc055">lbm_errmsg</a>());</div><div class="line">                        rcv_cleanup(data);</div><div class="line">                        <span class="keywordflow">return</span> (rc);</div><div class="line">                }</div><div class="line">                entry++;</div><div class="line">        }</div><div class="line"></div><div class="line">        <span class="comment">/* For a non-wildcard topic, lookup the topic. */</span></div><div class="line">        <span class="keywordflow">if</span> (wildcard_topic[0] == <span class="charliteral">&#39;\0&#39;</span>)</div><div class="line">        {</div><div class="line">                rc = <a class="code" href="lbm_8h.html#a3de8a6a659896f76475c453683db4e18">lbm_rcv_topic_lookup</a>(&amp;(data-&gt;mTopic), data-&gt;mContext, topic, data-&gt;mTopicAttributes);</div><div class="line">                <span class="keywordflow">if</span> (rc == LBM_FAILURE)</div><div class="line">                {</div><div class="line">                        snprintf(ErrorString,</div><div class="line">                                         <span class="keyword">sizeof</span>(ErrorString),</div><div class="line">                                         <span class="stringliteral">&quot;lbm_rcv_topic_lookup() failed, %s&quot;</span>,</div><div class="line">                                         <a class="code" href="lbm_8h.html#a22a4650d3a5b649c84a0c05adedcc055">lbm_errmsg</a>());</div><div class="line">                        rcv_cleanup(data);</div><div class="line">                        <span class="keywordflow">return</span> (rc);</div><div class="line">                }</div><div class="line">        }</div><div class="line"></div><div class="line"><span class="preprocessor">#ifdef _WIN32</span></div><div class="line">        InitializeCriticalSection(&amp;(data-&gt;mLock));</div><div class="line"><span class="preprocessor">#else</span></div><div class="line">        pthread_mutex_init(&amp;(data-&gt;mLock), NULL);</div><div class="line"><span class="preprocessor">#endif</span></div><div class="line">        data-&gt;mLockCreated = 1;</div><div class="line">        lock_receiver(data);</div><div class="line">        <span class="keywordflow">if</span> (wildcard_topic[0] != <span class="charliteral">&#39;\0&#39;</span>)</div><div class="line">        {</div><div class="line">                <span class="comment">/* Wildcard topic, create a wildcard receiver */</span></div><div class="line">                rc = <a class="code" href="lbm_8h.html#a5b5d52f6b87499213757b73b09bc8160">lbm_wildcard_rcv_create</a>(&amp;(data-&gt;mWildcardReceiver),</div><div class="line">                                                                         data-&gt;mContext,</div><div class="line">                                                                         wildcard_topic,</div><div class="line">                                                                         data-&gt;mTopicAttributes,</div><div class="line">                                                                         data-&gt;mWildcardReceiverAttributes,</div><div class="line">                                                                         receive_callback,</div><div class="line">                                                                         data,</div><div class="line">                                                                         NULL);</div><div class="line">        }</div><div class="line">        <span class="keywordflow">else</span></div><div class="line">        {</div><div class="line">                <span class="comment">/* Non-wildcard topic, create a normal receiver */</span></div><div class="line">                rc = <a class="code" href="lbm_8h.html#aa7491c50fefbc2b70f8035fce7ac1477">lbm_rcv_create</a>(&amp;(data-&gt;mReceiver),</div><div class="line">                                                        data-&gt;mContext,</div><div class="line">                                                        data-&gt;mTopic,</div><div class="line">                                                        receive_callback,</div><div class="line">                                                        data,</div><div class="line">                                                        NULL);</div><div class="line">        }</div><div class="line">        <span class="keywordflow">if</span> (rc == LBM_FAILURE)</div><div class="line">        {</div><div class="line">                snprintf(ErrorString,</div><div class="line">                                 <span class="keyword">sizeof</span>(ErrorString),</div><div class="line">                                 <span class="stringliteral">&quot;lbm_wildcard_rcv_create()/lbm_rcv_create() failed, %s&quot;</span>,</div><div class="line">                                 <a class="code" href="lbm_8h.html#a22a4650d3a5b649c84a0c05adedcc055">lbm_errmsg</a>());</div><div class="line">                unlock_receiver(data);</div><div class="line">                rcv_cleanup(data);</div><div class="line">                <span class="keywordflow">return</span> (rc);</div><div class="line">        }</div><div class="line"></div><div class="line">        <span class="comment">/* Pass back the lbmmon_transport_lbm_rcv_t created */</span></div><div class="line">        *TransportClientData = data;</div><div class="line">        unlock_receiver(data);</div><div class="line">        <span class="keywordflow">return</span> (0);</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keywordtype">int</span></div><div class="line">lbmmon_transport_lbm_send(<span class="keyword">const</span> <span class="keywordtype">char</span> * Data, <span class="keywordtype">size_t</span> Length, <span class="keywordtype">void</span> * TransportClientData)</div><div class="line">{</div><div class="line">        lbmmon_transport_lbm_src_t * src;</div><div class="line">        <span class="keywordtype">int</span> rc;</div><div class="line"></div><div class="line">        <span class="keywordflow">if</span> ((Data == NULL) || (TransportClientData == NULL))</div><div class="line">        {</div><div class="line">                strncpy(ErrorString, <span class="stringliteral">&quot;Invalid argument&quot;</span>, <span class="keyword">sizeof</span>(ErrorString));</div><div class="line">                <span class="keywordflow">return</span> (-1);</div><div class="line">        }</div><div class="line">        src = (lbmmon_transport_lbm_src_t *) TransportClientData;</div><div class="line">        rc = <a class="code" href="lbm_8h.html#a91f4b9cb04fe1323ec56833211cc5cb7">lbm_src_send</a>(src-&gt;mSource, Data, Length, 0);</div><div class="line">        <span class="keywordflow">if</span> (rc == LBM_FAILURE)</div><div class="line">        {</div><div class="line">                snprintf(ErrorString,</div><div class="line">                                 <span class="keyword">sizeof</span>(ErrorString),</div><div class="line">                                 <span class="stringliteral">&quot;lbm_src_send() failed, %s&quot;</span>,</div><div class="line">                                 <a class="code" href="lbm_8h.html#a22a4650d3a5b649c84a0c05adedcc055">lbm_errmsg</a>());</div><div class="line">        }</div><div class="line">        <span class="keywordflow">return</span> (rc);</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keywordtype">int</span></div><div class="line">lbmmon_transport_lbm_receive(<span class="keywordtype">char</span> * Data, <span class="keywordtype">size_t</span> * Length, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> TimeoutMS, <span class="keywordtype">void</span> * TransportClientData)</div><div class="line">{</div><div class="line">        lbmmon_transport_lbm_rcv_t * rcv = (lbmmon_transport_lbm_rcv_t *) TransportClientData;</div><div class="line">        lbmmon_transport_lbm_rcv_node_t * node;</div><div class="line">        <span class="keywordtype">int</span> rc = 0;</div><div class="line">        <span class="keywordtype">size_t</span> length_remaining;</div><div class="line"><span class="preprocessor">#if defined(_WIN32)</span></div><div class="line"><span class="preprocessor">#elif defined(__TANDEM)</span></div><div class="line">        <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> sleep_sec;</div><div class="line">        <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> sleep_usec;</div><div class="line"><span class="preprocessor">#else</span></div><div class="line">        <span class="keyword">struct </span>timespec ivl;</div><div class="line"><span class="preprocessor">#endif</span></div><div class="line"></div><div class="line">        <span class="keywordflow">if</span> ((Data == NULL) || (Length == NULL) || (TransportClientData == NULL))</div><div class="line">        {</div><div class="line">                strncpy(ErrorString, <span class="stringliteral">&quot;Invalid argument&quot;</span>, <span class="keyword">sizeof</span>(ErrorString));</div><div class="line">                <span class="keywordflow">return</span> (-1);</div><div class="line">        }</div><div class="line">        <span class="keywordflow">if</span> (*Length == 0)</div><div class="line">        {</div><div class="line">                <span class="keywordflow">return</span> (0);</div><div class="line">        }</div><div class="line">        lock_receiver(rcv);</div><div class="line">        <span class="keywordflow">if</span> (rcv-&gt;mHead != NULL)</div><div class="line">        {</div><div class="line">                <span class="comment">/* Queue is non-empty. Pull the first message from the queue. */</span></div><div class="line">                node = rcv-&gt;mHead;</div><div class="line">                length_remaining = node-&gt;mMessage-&gt;len - node-&gt;mUsedBytes;</div><div class="line">                <span class="keywordflow">if</span> (*Length &gt;= length_remaining)</div><div class="line">                {</div><div class="line">                        <span class="comment">/* We can transfer the rest of the message */</span></div><div class="line">                        memcpy(Data, node-&gt;mMessage-&gt;data + node-&gt;mUsedBytes, length_remaining);</div><div class="line">                        *Length = length_remaining;</div><div class="line">                        rc = 0;</div><div class="line">                        <span class="comment">/* We&#39;re done with the LBM message, so let LBM know. */</span></div><div class="line">                        <a class="code" href="lbm_8h.html#aa5fc1eb324a55b8c800c31460b0f0116">lbm_msg_delete</a>(node-&gt;mMessage);</div><div class="line">                        <span class="comment">/* Unlink the node from the queue */</span></div><div class="line">                        rcv-&gt;mHead = node-&gt;mNext;</div><div class="line">                        <span class="keywordflow">if</span> (rcv-&gt;mHead == NULL)</div><div class="line">                        {</div><div class="line">                                rcv-&gt;mTail = NULL;</div><div class="line">                        }</div><div class="line">                        free(node);</div><div class="line">                }</div><div class="line">                <span class="keywordflow">else</span></div><div class="line">                {</div><div class="line">                        <span class="comment">/* MSGDESC: The monitoring message received is larger than the maximum allowed size given.</span></div><div class="line"><span class="comment">                         * MSGRES: This is a hard coded maximum. */</span></div><div class="line">                        <a class="code" href="lbm_8h.html#aaa36f4dcd32603a33c0a2c129dd2c3aa">lbm_logf</a>(<a class="code" href="lbm_8h.html#a5924551ebcb0e0cc96ddacb76c60de24">LBM_LOG_ERR</a>, <span class="stringliteral">&quot;Core-8034-1: [LBMMON] Dropping monitoring message that is larger than the maximum allowed size of %d (size=%d)&quot;</span>,</div><div class="line">                                                        *Length, node-&gt;mMessage-&gt;len);</div><div class="line">                        <span class="comment">/* We&#39;re done with the LBM message, so let LBM know. */</span></div><div class="line">                        <a class="code" href="lbm_8h.html#aa5fc1eb324a55b8c800c31460b0f0116">lbm_msg_delete</a>(node-&gt;mMessage);</div><div class="line">                        <span class="comment">/* Unlink the node from the queue */</span></div><div class="line">                        rcv-&gt;mHead = node-&gt;mNext;</div><div class="line">                        <span class="keywordflow">if</span> (rcv-&gt;mHead == NULL)</div><div class="line">                        {</div><div class="line">                                rcv-&gt;mTail = NULL;</div><div class="line">                        }</div><div class="line">                        free(node);</div><div class="line">                        rc = 1; <span class="comment">/* Positive number prevents caller from logging message too */</span></div><div class="line">                }</div><div class="line">                unlock_receiver(rcv);</div><div class="line">        }</div><div class="line">        <span class="keywordflow">else</span></div><div class="line">        {</div><div class="line">                unlock_receiver(rcv);</div><div class="line">                <span class="comment">/* Sleep for wait time */</span></div><div class="line"><span class="preprocessor">#define NANOSECONDS_PER_SECOND 1000000000</span></div><div class="line"><span class="preprocessor">#define MICROSECONDS_PER_SECOND 1000000</span></div><div class="line"><span class="preprocessor">#define MILLISECONDS_PER_SECOND 1000</span></div><div class="line"><span class="preprocessor">#define NANOSECONDS_PER_MILLISECOND (NANOSECONDS_PER_SECOND / MILLISECONDS_PER_SECOND)</span></div><div class="line"><span class="preprocessor">#define MICROSECONDS_PER_MILLISECOND (MICROSECONDS_PER_SECOND / MILLISECONDS_PER_SECOND)</span></div><div class="line"><span class="preprocessor">#if defined(_WIN32)</span></div><div class="line">                Sleep(TimeoutMS);</div><div class="line"><span class="preprocessor">#elif defined(__TANDEM)</span></div><div class="line">                sleep_sec = TimeoutMS / MILLISECONDS_PER_SECOND;</div><div class="line">                sleep_usec = (TimeoutMS % MILLISECONDS_PER_SECOND) * MICROSECONDS_PER_MILLISECOND;</div><div class="line">                <span class="keywordflow">if</span> (sleep_usec &gt; 0)</div><div class="line">                {</div><div class="line">                        usleep(sleep_usec);</div><div class="line">                }</div><div class="line">                <span class="keywordflow">if</span> (sleep_sec &gt; 0)</div><div class="line">                {</div><div class="line">                        sleep(sleep_sec);</div><div class="line">                }</div><div class="line"><span class="preprocessor">#else</span></div><div class="line">                ivl.tv_sec = TimeoutMS / MILLISECONDS_PER_SECOND;</div><div class="line">                ivl.tv_nsec = (TimeoutMS % MILLISECONDS_PER_SECOND) * NANOSECONDS_PER_MILLISECOND;</div><div class="line">                nanosleep(&amp;ivl, NULL);</div><div class="line"><span class="preprocessor">#endif</span></div><div class="line">                rc = 1;</div><div class="line">        }</div><div class="line">        <span class="keywordflow">return</span> (rc);</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keywordtype">void</span></div><div class="line">src_cleanup(lbmmon_transport_lbm_src_t * Data)</div><div class="line">{</div><div class="line">        <span class="keywordflow">if</span> (Data-&gt;mSource != NULL)</div><div class="line">        {</div><div class="line">                <a class="code" href="lbm_8h.html#a29d45db8f76835b4ae78f4568c25712f">lbm_src_delete</a>(Data-&gt;mSource);</div><div class="line">                Data-&gt;mSource = NULL;</div><div class="line">        }</div><div class="line">        Data-&gt;mTopic = NULL;</div><div class="line">        <span class="keywordflow">if</span> (Data-&gt;mTopicAttributes != NULL)</div><div class="line">        {</div><div class="line">                <a class="code" href="lbm_8h.html#acb24cc75476206c155b00c4994aece85">lbm_src_topic_attr_delete</a>(Data-&gt;mTopicAttributes);</div><div class="line">                Data-&gt;mTopicAttributes = NULL;</div><div class="line">        }</div><div class="line">        <span class="keywordflow">if</span> (Data-&gt;mContext != NULL)</div><div class="line">        {</div><div class="line">                <a class="code" href="lbm_8h.html#a962bfceb336c65191ba08497ac70602b">lbm_context_delete</a>(Data-&gt;mContext);</div><div class="line">                Data-&gt;mContext = NULL;</div><div class="line">        }</div><div class="line">        <span class="keywordflow">if</span> (Data-&gt;mContextAttributes != NULL)</div><div class="line">        {</div><div class="line">                <a class="code" href="lbm_8h.html#a9c0a3c1f4a8854d8ec5585392c817c85">lbm_context_attr_delete</a>(Data-&gt;mContextAttributes);</div><div class="line">                Data-&gt;mContextAttributes = NULL;</div><div class="line">        }</div><div class="line">        free(Data);</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keywordtype">int</span></div><div class="line">lbmmon_transport_lbm_src_finish(<span class="keywordtype">void</span> * TransportClientData)</div><div class="line">{</div><div class="line">        lbmmon_transport_lbm_src_t * src;</div><div class="line"></div><div class="line">        <span class="keywordflow">if</span> (TransportClientData == NULL)</div><div class="line">        {</div><div class="line">                strncpy(ErrorString, <span class="stringliteral">&quot;Invalid argument&quot;</span>, <span class="keyword">sizeof</span>(ErrorString));</div><div class="line">                <span class="keywordflow">return</span> (-1);</div><div class="line">        }</div><div class="line">        src = (lbmmon_transport_lbm_src_t *) TransportClientData;</div><div class="line">        src_cleanup(src);</div><div class="line">        <span class="keywordflow">return</span> (0);</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keywordtype">void</span></div><div class="line">rcv_cleanup(lbmmon_transport_lbm_rcv_t * Data)</div><div class="line">{</div><div class="line">        lbmmon_transport_lbm_rcv_node_t * node;</div><div class="line">        lbmmon_transport_lbm_rcv_node_t * next;</div><div class="line"></div><div class="line">        <span class="comment">/* Stop the receiver to prevent any more incoming messages */</span></div><div class="line">        <span class="keywordflow">if</span> (Data-&gt;mWildcardReceiver != NULL)</div><div class="line">        {</div><div class="line">                <a class="code" href="lbm_8h.html#a64407f3874012efaebcba322ea6d229d">lbm_wildcard_rcv_delete</a>(Data-&gt;mWildcardReceiver);</div><div class="line">                Data-&gt;mWildcardReceiver = NULL;</div><div class="line">        }</div><div class="line">        <span class="keywordflow">if</span> (Data-&gt;mWildcardReceiverAttributes != NULL)</div><div class="line">        {</div><div class="line">                <a class="code" href="lbm_8h.html#ae9ec474237895a81cf15a4e14619cd25">lbm_wildcard_rcv_attr_delete</a>(Data-&gt;mWildcardReceiverAttributes);</div><div class="line">                Data-&gt;mWildcardReceiverAttributes = NULL;</div><div class="line">        }</div><div class="line">        <span class="keywordflow">if</span> (Data-&gt;mReceiver != NULL)</div><div class="line">        {</div><div class="line">                <a class="code" href="lbm_8h.html#a8d5e8713f5ae776330b23a1e371f934d">lbm_rcv_delete</a>(Data-&gt;mReceiver);</div><div class="line">                Data-&gt;mReceiver = NULL;</div><div class="line">        }</div><div class="line">        <span class="keywordflow">if</span> (Data-&gt;mTopicAttributes != NULL)</div><div class="line">        {</div><div class="line">                <a class="code" href="lbm_8h.html#af70d14c26efadade6ad1e22d254f4e1b">lbm_rcv_topic_attr_delete</a>(Data-&gt;mTopicAttributes);</div><div class="line">                Data-&gt;mTopicAttributes = NULL;</div><div class="line">        }</div><div class="line">        Data-&gt;mTopic = NULL;</div><div class="line"></div><div class="line">        <span class="comment">/* Lock the receiver */</span></div><div class="line">        <span class="keywordflow">if</span> (Data-&gt;mLockCreated != 0)</div><div class="line">        {</div><div class="line">                lock_receiver(Data);</div><div class="line">        }</div><div class="line"></div><div class="line">        <span class="comment">/* Delete the context to really make sure no more messages come in */</span></div><div class="line">        <span class="keywordflow">if</span> (Data-&gt;mContext != NULL)</div><div class="line">        {</div><div class="line">                <a class="code" href="lbm_8h.html#a962bfceb336c65191ba08497ac70602b">lbm_context_delete</a>(Data-&gt;mContext);</div><div class="line">                Data-&gt;mContext = NULL;</div><div class="line">        }</div><div class="line">        <span class="keywordflow">if</span> (Data-&gt;mContextAttributes != NULL)</div><div class="line">        {</div><div class="line">                <a class="code" href="lbm_8h.html#a9c0a3c1f4a8854d8ec5585392c817c85">lbm_context_attr_delete</a>(Data-&gt;mContextAttributes);</div><div class="line">                Data-&gt;mContextAttributes = NULL;</div><div class="line">        }</div><div class="line"></div><div class="line">        <span class="comment">/* Clean out the queue */</span></div><div class="line">        node = Data-&gt;mHead;</div><div class="line">        <span class="keywordflow">while</span> (node != NULL)</div><div class="line">        {</div><div class="line">                <span class="comment">/* Let LBM know we&#39;re done with the message */</span></div><div class="line">                <a class="code" href="lbm_8h.html#aa5fc1eb324a55b8c800c31460b0f0116">lbm_msg_delete</a>(node-&gt;mMessage);</div><div class="line">                next = node-&gt;mNext;</div><div class="line">                free(node);</div><div class="line">                node = next;</div><div class="line">        }</div><div class="line"></div><div class="line">        <span class="keywordflow">if</span> (Data-&gt;mLockCreated)</div><div class="line">        {</div><div class="line">                unlock_receiver(Data);</div><div class="line"><span class="preprocessor">#ifdef _WIN32</span></div><div class="line">                DeleteCriticalSection(&amp;(Data-&gt;mLock));</div><div class="line"><span class="preprocessor">#else</span></div><div class="line">                pthread_mutex_destroy(&amp;(Data-&gt;mLock));</div><div class="line"><span class="preprocessor">#endif</span></div><div class="line">        }</div><div class="line"></div><div class="line">        free(Data);</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keywordtype">int</span></div><div class="line">lbmmon_transport_lbm_rcv_finish(<span class="keywordtype">void</span> * TransportClientData)</div><div class="line">{</div><div class="line">        lbmmon_transport_lbm_rcv_t * rcv;</div><div class="line"></div><div class="line">        <span class="keywordflow">if</span> (TransportClientData == NULL)</div><div class="line">        {</div><div class="line">                strncpy(ErrorString, <span class="stringliteral">&quot;Invalid argument&quot;</span>, <span class="keyword">sizeof</span>(ErrorString));</div><div class="line">                <span class="keywordflow">return</span> (-1);</div><div class="line">        }</div><div class="line">        rcv = (lbmmon_transport_lbm_rcv_t *) TransportClientData;</div><div class="line">        rcv_cleanup(rcv);</div><div class="line">        <span class="keywordflow">return</span> (0);</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keywordtype">void</span></div><div class="line">lock_receiver(lbmmon_transport_lbm_rcv_t * Receiver)</div><div class="line">{</div><div class="line"><span class="preprocessor">#ifdef _WIN32</span></div><div class="line">        EnterCriticalSection(&amp;(Receiver-&gt;mLock));</div><div class="line"><span class="preprocessor">#else</span></div><div class="line">        pthread_mutex_lock(&amp;(Receiver-&gt;mLock));</div><div class="line"><span class="preprocessor">#endif</span></div><div class="line">}</div><div class="line"></div><div class="line"><span class="keywordtype">void</span></div><div class="line">unlock_receiver(lbmmon_transport_lbm_rcv_t * Receiver)</div><div class="line">{</div><div class="line"><span class="preprocessor">#ifdef _WIN32</span></div><div class="line">        LeaveCriticalSection(&amp;(Receiver-&gt;mLock));</div><div class="line"><span class="preprocessor">#else</span></div><div class="line">        pthread_mutex_unlock(&amp;(Receiver-&gt;mLock));</div><div class="line"><span class="preprocessor">#endif</span></div><div class="line">}</div><div class="line"></div><div class="line"><span class="keyword">const</span> <span class="keywordtype">char</span> *</div><div class="line">lbmmon_transport_lbm_errmsg(<span class="keywordtype">void</span>)</div><div class="line">{</div><div class="line">        <span class="keywordflow">return</span> (ErrorString);</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keywordtype">int</span></div><div class="line">scope_is_valid(<span class="keyword">const</span> <span class="keywordtype">char</span> * Scope)</div><div class="line">{</div><div class="line">        <span class="keywordflow">if</span> (strcasecmp(Scope, <span class="stringliteral">&quot;context&quot;</span>) == 0)</div><div class="line">        {</div><div class="line">                <span class="keywordflow">return</span> (0);</div><div class="line">        }</div><div class="line">        <span class="keywordflow">if</span> (strcasecmp(Scope, <span class="stringliteral">&quot;source&quot;</span>) == 0)</div><div class="line">        {</div><div class="line">                <span class="keywordflow">return</span> (0);</div><div class="line">        }</div><div class="line">        <span class="keywordflow">if</span> (strcasecmp(Scope, <span class="stringliteral">&quot;receiver&quot;</span>) == 0)</div><div class="line">        {</div><div class="line">                <span class="keywordflow">return</span> (0);</div><div class="line">        }</div><div class="line">        <span class="keywordflow">if</span> (strcasecmp(Scope, <span class="stringliteral">&quot;event_queue&quot;</span>) == 0)</div><div class="line">        {</div><div class="line">                <span class="keywordflow">return</span> (0);</div><div class="line">        }</div><div class="line">        <span class="keywordflow">return</span> (-1);</div><div class="line">}</div><div class="line"></div></div><!-- fragment --> </div></div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="lbmmon_examples.html">LBMMON Example source code</a></li><li class="navelem"><a class="el" href="lbmmon_lbm_transport.html">LBMMON LBM transport module</a></li>
    <li class="footer">Generated by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.11 </li>
  </ul>
</div>
</body>
</html>
