<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.11"/>
<title>Concepts Guide: Architecture</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
  $(window).load(resizeHeight);
</script>
<link href="doxygen_manual.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Concepts Guide
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.11 -->
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('architecture.html','');});
</script>
<div id="doc-content">
<div class="header">
  <div class="headertitle">
<div class="title">Architecture </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>UM is designed to be a flexible architecture. Unlike many messaging systems, UM does not require an intermediate daemon to handle routing issues or protocol processing. This increases the performance of UM and returns valuable computation time and memory back to applications that would normally be consumed by messaging daemons.</p>
<p><br />
 </p>
<h1><a class="anchor" id="embeddedmode"></a>
Embedded Mode</h1>
<p>When you create a context (<a class="elRef" doxygen="/29W/Amun/home/jenkins/backup_exclude.1/rc/UMQ_6.11.1_RC1/doc/Design/api.tag:../API/" href="../API/lbm_8h.html#a8058947690bd0995bc2c59d4a61b462f">lbm_context_create()</a>) with the UM configuration option <a class="elRef" doxygen="/29W/Amun/home/jenkins/backup_exclude.1/rc/UMQ_6.11.1_RC1/doc/Design/config.tag:../Config/" href="../Config/grpmajoroptions.html#operationalmodecontext">operational_mode (context)</a> set to embedded (the default), UM creates an independent thread, called the context thread, which handles timer and socket events, and does protocol-level processing, like retransmission of dropped packets.</p>
<p><br />
 </p>
<h1><a class="anchor" id="sequentialmode"></a>
Sequential Mode</h1>
<p>When you create a context (<a class="elRef" doxygen="/29W/Amun/home/jenkins/backup_exclude.1/rc/UMQ_6.11.1_RC1/doc/Design/api.tag:../API/" href="../API/lbm_8h.html#a8058947690bd0995bc2c59d4a61b462f">lbm_context_create()</a>) with the UM configuration option <a class="elRef" doxygen="/29W/Amun/home/jenkins/backup_exclude.1/rc/UMQ_6.11.1_RC1/doc/Design/config.tag:../Config/" href="../Config/grpmajoroptions.html#operationalmodecontext">operational_mode (context)</a> set to sequential, the context thread is NOT created. It becomes the application's responsibility to donate a thread to UM by calling <a class="elRef" doxygen="/29W/Amun/home/jenkins/backup_exclude.1/rc/UMQ_6.11.1_RC1/doc/Design/api.tag:../API/" href="../API/lbm_8h.html#ad9416b1f0b474b5d4c4f39bb3c4bda77">lbm_context_process_events()</a> regularly, typically in a tight loop. Use Sequential mode for circumstances where your application wants control over the attributes of the context thread. For example, some applications raise the priority of the context thread so as to obtain more consistent latencies. In sequential mode, no separate thread is spawned when a context is created.</p>
<p>You enable Sequential mode with the following configuration option.</p>
<pre class="fragment">context operational_mode sequential
</pre><p>In addition to the context thread, there are other UM features which rely on specialized threads: </p><ul>
<li>
The LBT-IPC transport type, when used, creates its own specialized receive thread. Similar to the context thread, the creation of this thread can be suppressed by setting the option <a class="elRef" doxygen="/29W/Amun/home/jenkins/backup_exclude.1/rc/UMQ_6.11.1_RC1/doc/Design/config.tag:../Config/" href="../Config/grptransportlbtipcoperation.html#transportlbtipcreceiveroperationalmodecontext">transport_lbtipc_receiver_operational_mode (context)</a> to sequential. The application must then call <a class="elRef" doxygen="/29W/Amun/home/jenkins/backup_exclude.1/rc/UMQ_6.11.1_RC1/doc/Design/api.tag:../API/" href="../API/lbm_8h.html#a8729a284ef9f01f329fbf0edbc147227">lbm_context_process_lbtipc_messages()</a> regularly. </li>
<li>
The LBT-SMX transport type, when used, creates its own specialized receive thread. However, unlike the context thread and the LBT-IPC threads, the creation of the LBT-SMX thread is handled by UM. There is no sequential mode for the LBT-SMX thread. </li>
<li>
The <a class="elRef" doxygen="/29W/Amun/home/jenkins/backup_exclude.1/rc/UMQ_6.11.1_RC1/doc/Design/config.tag:../Config/" href="../Config/grptransportacceleration.html#myricomdatagrambypasslayerdbl">DBL transport acceleration</a>, when used, creates its own specialized receive thread. However, unlike the context thread and the LBT-IPC threads, the creation of the DBL thread is handled by UM. There is no sequential mode for the DBL thread. </li>
</ul>
<p><br />
 </p>
<h1><a class="anchor" id="topicresolutiondescription"></a>
Topic Resolution Description</h1>
<p>Topic resolution is the discovery of a topic's transport session information by a receiver to enable the receipt of topic messages. By default, Ultra Messaging Ultra Messaging relies on multicast requests and responses to resolve topics to transport sessions. (You can also use Unicast requests and responses, if needed.) Ultra Messaging receivers multicast their topic requests, or queries, to an IP multicast address and UDP port configured with the Ultra Messaging configuration options, <a class="elRef" doxygen="/29W/Amun/home/jenkins/backup_exclude.1/rc/UMQ_6.11.1_RC1/doc/Design/config.tag:../Config/" href="../Config/grpmulticastresolvernetwork.html#resolvermulticastaddresscontext">resolver_multicast_address (context)</a> and <a class="elRef" doxygen="/29W/Amun/home/jenkins/backup_exclude.1/rc/UMQ_6.11.1_RC1/doc/Design/config.tag:../Config/" href="../Config/grpmulticastresolvernetwork.html#resolvermulticastportcontext">resolver_multicast_port (context)</a>). Ultra Messaging sources also multicast their advertisements and responses to receiver queries to the same multicast address and UDP port.</p>
<p>Topic Resolution occurs in the following phases:</p>
<ul>
<li>
Initial Phase - Period that allows you to resolve a topic aggressively. Can be used to resolve all known topics before message sending begins. This phase can be configured to run differently from the defaults or completely disabled. </li>
<li>
Sustaining Phase - Period that allows new receivers to resolve a topic after the Initial Phase. Can also be the primary period of topic resolution if you disable the Initial Phase. This phase can also be configured to run differently from the defaults or completely disabled. </li>
<li>
Quiescent Phase - The "steady state" period during which a topic is resolved and Ultra Messaging uses no system resources for topic resolution. </li>
</ul>
<p>The phases of topic resolution pertain to individual topics. Therefore if your system has 100 topics, 100 different topic resolution advertisement and query phases may be running concurrently. This describes the three phases of Ultra Messaging topic resolution.</p>
<dl class="section note"><dt>Note</dt><dd>With the UMQ product, topic resolution does not apply to brokered queuing sources, receivers, or the brokers themselves. However, ULB queuing does make use of topic resolution.</dd></dl>
<p><br />
 </p>
<h2><a class="anchor" id="multicasttopicresolution"></a>
Multicast Topic Resolution</h2>
<p>The following diagram depicts the UM topic resolution using multicast.</p>
<div class="image">
<img src="TopicResolution.png" alt="TopicResolution.png"/>
</div>
 <p>UM performs topic resolution automatically. Your application does not need to call any API functions to initiate topic resolution, however, you can influence topic resolution with <a class="el" href="architecture.html#topicresolutionconfigurationoptions">Topic Resolution Configuration Options</a>. Moreover, you can set configuration options for individual topics by using the lbm_*_attr_setopt() functions in your application. See <a class="el" href="architecture.html#topicresolutionconfigurationoptions">Topic Resolution Configuration Options</a> for details.</p>
<p>Topic Resolution also occurs across UM Routers, which means between Topic Resolution Domains. A Topic Resolution Domain refers to all the UM contexts that use the same UM topic resolution configuration values, such as <a class="elRef" doxygen="/29W/Amun/home/jenkins/backup_exclude.1/rc/UMQ_6.11.1_RC1/doc/Design/config.tag:../Config/" href="../Config/grpmulticastresolvernetwork.html#resolvermulticastaddresscontext">resolver_multicast_address (context)</a> and <a class="elRef" doxygen="/29W/Amun/home/jenkins/backup_exclude.1/rc/UMQ_6.11.1_RC1/doc/Design/config.tag:../Config/" href="../Config/grpmulticastresolvernetwork.html#resolvermulticastportcontext">resolver_multicast_port (context)</a>. UM Routers automatically assign Topic Resolution Domain IDs and manage Topic resolution traffic across them. See the UM Router Guide for more information.</p>
<p>Multicast topic resolution traffic can benefit from hardware acceleration. See <a class="elRef" doxygen="/29W/Amun/home/jenkins/backup_exclude.1/rc/UMQ_6.11.1_RC1/doc/Design/config.tag:../Config/" href="../Config/grptransportacceleration.html">Transport Acceleration Options</a> in the <a href="../Config/index.html">UM Configuration Guide</a> for more information.</p>
<dl class="section note"><dt>Note</dt><dd>The Unicast Topic Resolution Daemon (lbmrd) can not run on the OpenVMS platform. If unicast topic resolution is needed with OpenVMS, the lbmrd must be run on an alternate platform (e.g. Linux or Windows).</dd></dl>
<p><br />
 </p>
<h2><a class="anchor" id="sourcesadvertise"></a>
Sources Advertise</h2>
<p>Ultra Messaging sources help Ultra Messaging receivers discover transport information in the following ways:</p>
<dl class="section user"><dt><b>Advertise</b> <b>Active</b> <b>Topics</b> </dt><dd>Each source advertises its active topic first upon its creation and subsequently according to the resolver_advertisement_*_interval configuration options for the Initial and Sustaining Phases. Sources advertise by sending a Topic Information Record (TIR). (You can prevent a source from sending an advertisement upon creation with <a class="elRef" doxygen="/29W/Amun/home/jenkins/backup_exclude.1/rc/UMQ_6.11.1_RC1/doc/Design/config.tag:../Config/" href="../Config/grpresolveroperation.html#resolversendinitialadvertisementsource">resolver_send_initial_advertisement (source)</a>.)</dd></dl>
<dl class="section user"><dt><b>Respond</b> <b>to</b> <b>Topic</b> <b>Queries</b> </dt><dd>Each source responds immediately to queries from receivers about its topic.</dd></dl>
<p>Both a topic advertisement and a query response contain the topic's transport session information. Based on the transport type, a receiver can join the appropriate multicast group (for LBT-RM), send a connection request (for LBT-RU), connect to the source (for TCP) or access a shared memory area (for LBT-IPC and SMX). A TIR may contain the following address and port information:</p>
<ul>
<li>
For a TCP transport, the source address, TCP port and Session ID. </li>
<li>
For an LBT-RM transport, the multicast group address, LBT-RM Session ID and the unicast UDP port (to which NAKs are sent) and the UDP destination port. </li>
<li>
For an LBT-RU transport, the source address, UDP port and Session ID. </li>
<li>
For an LBT-IPC transport, the Host ID, LBT-IPC Session ID and Transport ID. </li>
<li>
For an LBT-SMX transport, the Host ID, LBT-SMX Session ID and Transport ID. </li>
<li>
For an LBT-RDMA transport, the source address, RDMA port and Session ID. </li>
</ul>
<p>See <a class="elRef" doxygen="/29W/Amun/home/jenkins/backup_exclude.1/rc/UMQ_6.11.1_RC1/doc/Design/config.tag:../Config/" href="../Config/grpresolveroperation.html">Resolver Operation Options</a> in the <a href="../../Config/index.html">UM Configuration Guide</a> for more information.</p>
<p>With the UMP/UMQ products, any Persistent sources you configure to send to Persistent Stores by setting the <a class="elRef" doxygen="/29W/Amun/home/jenkins/backup_exclude.1/rc/UMQ_6.11.1_RC1/doc/Design/config.tag:../Config/" href="../Config/grpultramessagingpersistence.html#umestoresource">ume_store (source)</a> configuration option, also include a Persistence flag in their advertisements. This indicates that the receiver should request the source to send a Source Registration Information (SRI) record, which identifies the store or stores the receiver should register with. See Source and Receiver Registration with the Store in the <a href="../UME/UM_Guide_for_Persistence=en.pdf">UM Guide for Persistence</a> for more information.</p>
<p><br />
 </p>
<h2><a class="anchor" id="receiversquery"></a>
Receivers Query</h2>
<p>Receivers can discover transport information in the following ways.</p>
<ul>
<li>
Search advertisements collected in the resolver cache maintained by the UM context. </li>
<li>
Listen for source advertisements on the resolver_multicast_address:port. </li>
<li>
Send a topic query (TQR). </li>
</ul>
<p>A new receiver queries for its topic according to the resolver_query_*_interval configuration options for the Initial and Sustaining Phases.</p>
<p>Note that the <a class="elRef" doxygen="/29W/Amun/home/jenkins/backup_exclude.1/rc/UMQ_6.11.1_RC1/doc/Design/config.tag:../Config/" href="../Config/grpresolveroperation.html#resolverqueryminimuminitialintervalreceiver">resolver_query_minimum_initial_interval (receiver)</a> actually begins after you call <a class="elRef" doxygen="/29W/Amun/home/jenkins/backup_exclude.1/rc/UMQ_6.11.1_RC1/doc/Design/api.tag:../API/" href="../API/lbm_8h.html#a3de8a6a659896f76475c453683db4e18">lbm_rcv_topic_lookup()</a> prior to creating the receiver. If you have disabled the Initial Phase for the topic's resolution, the <a class="elRef" doxygen="/29W/Amun/home/jenkins/backup_exclude.1/rc/UMQ_6.11.1_RC1/doc/Design/config.tag:../Config/" href="../Config/grpresolveroperation.html#resolveradvertisementsustainintervalsource">resolver_advertisement_sustain_interval (source)</a> begins after you call <a class="elRef" doxygen="/29W/Amun/home/jenkins/backup_exclude.1/rc/UMQ_6.11.1_RC1/doc/Design/api.tag:../API/" href="../API/lbm_8h.html#a3de8a6a659896f76475c453683db4e18">lbm_rcv_topic_lookup()</a>.</p>
<p>A Topic Query Record (TQR) consists primarily of the topic string. Receivers continue querying on a topic until they discover the number of sources configured by <a class="elRef" doxygen="/29W/Amun/home/jenkins/backup_exclude.1/rc/UMQ_6.11.1_RC1/doc/Design/config.tag:../Config/" href="../Config/grpresolveroperation.html#resolutionnumberofsourcesquerythresholdreceiver">resolution_number_of_sources_query_threshold (receiver)</a>. However the large default of this configuration option (10,000,000) allows a receiver to continue to query until both the initial and sustaining phase of topic resolution complete.</p>
<p>See <a class="elRef" doxygen="/29W/Amun/home/jenkins/backup_exclude.1/rc/UMQ_6.11.1_RC1/doc/Design/config.tag:../Config/" href="../Config/grpresolveroperation.html">Resolver Operation Options</a> in the <a href="../../Config/index.html">UM Configuration Guide</a> for more information.</p>
<p><br />
 </p>
<h2><a class="anchor" id="wildcardreceivertopicresolution"></a>
Wildcard Receiver Topic Resolution</h2>
<p><a class="el" href="umobjects.html#umwildcardreceivers">UM Wildcard Receivers</a> can discover transport information in the following ways:</p>
<ul>
<li>
Search advertisements collected in the resolver cache maintained by the UM context. </li>
<li>
Listen for source advertisements on the resolver_multicast_address:port. </li>
<li>
Send a wildcard receiver topic query (WC-TQR). </li>
</ul>
<p>UM implements only one phase of wildcard receiver queries, sending wildcard receiver queries according to wildcard receiver resolver_query_*_interval configuration options until the topic pattern has been queried for the <a class="elRef" doxygen="/29W/Amun/home/jenkins/backup_exclude.1/rc/UMQ_6.11.1_RC1/doc/Design/config.tag:../Config/" href="../Config/grpwildcardreceiver.html#resolverqueryminimumdurationwildcardreceiver">resolver_query_minimum_duration (wildcard_receiver)</a>. The wildcard receiver topic query (WC-TQR) contains the topic pattern and the <a class="elRef" doxygen="/29W/Amun/home/jenkins/backup_exclude.1/rc/UMQ_6.11.1_RC1/doc/Design/config.tag:../Config/" href="../Config/grpwildcardreceiver.html#patterntypewildcardreceiver">pattern_type (wildcard_receiver)</a>.</p>
<p>See <a class="elRef" doxygen="/29W/Amun/home/jenkins/backup_exclude.1/rc/UMQ_6.11.1_RC1/doc/Design/config.tag:../Config/" href="../Config/grpwildcardreceiver.html">Wildcard Receiver Options</a> in the <a href="../../Config/index.html">UM Configuration Guide</a> for more information.</p>
<p><br />
 </p>
<h2><a class="anchor" id="initialphase"></a>
Initial Phase</h2>
<p>The initial topic resolution phase for a topic is an aggressive phase that can be used to resolve all topics before sending any messages. During the initial phase, network traffic and CPU utilization might actually be higher. You can completely disable this phase, if desired. See Disabling Aspects of Topic Resolution in the <a href="../Config/index.html">UM Configuration Guide</a>.</p>
<p><b>Advertising in the Initial Phase</b></p>
<p>For the initial phase default settings, the resolver issues the first advertisement as soon as the scheduler can process it. The resolver issues the second advertisement 10 ms later, or at the <a class="elRef" doxygen="/29W/Amun/home/jenkins/backup_exclude.1/rc/UMQ_6.11.1_RC1/doc/Design/config.tag:../Config/" href="../Config/grpresolveroperation.html#resolveradvertisementminimuminitialintervalsource">resolver_advertisement_minimum_initial_interval (source)</a>. For each subsequent advertisement, UM doubles the interval between advertisements. The source sends an advertisement at 20 ms, 40 ms, 80 ms, 160 ms, 320 ms and finally at 500 ms, or the <a class="elRef" doxygen="/29W/Amun/home/jenkins/backup_exclude.1/rc/UMQ_6.11.1_RC1/doc/Design/config.tag:../Config/" href="../Config/grpresolveroperation.html#resolveradvertisementmaximuminitialintervalsource">resolver_advertisement_maximum_initial_interval (source)</a>. These 8 advertisements require a total of 1130 ms. The interval between advertisements remains at the maximum 500 ms, resulting in 7 more advertisements before the total duration of the initial phase reaches 5000 ms, or the <a class="elRef" doxygen="/29W/Amun/home/jenkins/backup_exclude.1/rc/UMQ_6.11.1_RC1/doc/Design/config.tag:../Config/" href="../Config/grpresolveroperation.html#resolveradvertisementminimuminitialdurationsource">resolver_advertisement_minimum_initial_duration (source)</a>. This concludes the initial advertisement phase for the topic.</p>
<div class="image">
<img src="Resolver_Initial_Phase_TIR.png" alt="Resolver_Initial_Phase_TIR.png"/>
</div>
 <p>The initial phase for a topic can take longer than the <a class="elRef" doxygen="/29W/Amun/home/jenkins/backup_exclude.1/rc/UMQ_6.11.1_RC1/doc/Design/config.tag:../Config/" href="../Config/grpresolveroperation.html#resolveradvertisementminimuminitialdurationsource">resolver_advertisement_minimum_initial_duration (source)</a> if many topics are in resolution at the same time. The configuration options, <a class="elRef" doxygen="/29W/Amun/home/jenkins/backup_exclude.1/rc/UMQ_6.11.1_RC1/doc/Design/config.tag:../Config/" href="../Config/grpresolveroperation.html#resolverinitialadvertisementspersecondcontext">resolver_initial_advertisements_per_second (context)</a> and <a class="elRef" doxygen="/29W/Amun/home/jenkins/backup_exclude.1/rc/UMQ_6.11.1_RC1/doc/Design/config.tag:../Config/" href="../Config/grpresolveroperation.html#resolverinitialadvertisementbpscontext">resolver_initial_advertisement_bps (context)</a> enforce a rate limit on topic advertisements for the entire UM context. A large number of topics in resolution - in any phase - or long topic names may exceed these limits.</p>
<p>If a source advertising in the initial phase receives a topic query, it responds with a topic advertisement. UM recalculates the next advertisement interval from that point forward as if the advertisement was sent at the nearest interval.</p>
<p><b>Querying in the Initial Phase</b></p>
<p>Querying activity by receivers in the initial phase operates in similar fashion to advertising activity, although with different interval defaults. The <a class="elRef" doxygen="/29W/Amun/home/jenkins/backup_exclude.1/rc/UMQ_6.11.1_RC1/doc/Design/config.tag:../Config/" href="../Config/grpresolveroperation.html#resolverqueryminimuminitialintervalreceiver">resolver_query_minimum_initial_interval (receiver)</a> default is 20 ms. Subsequent intervals double in length until the interval reaches 200 ms, or the <a class="elRef" doxygen="/29W/Amun/home/jenkins/backup_exclude.1/rc/UMQ_6.11.1_RC1/doc/Design/config.tag:../Config/" href="../Config/grpresolveroperation.html#resolverquerymaximuminitialintervalreceiver">resolver_query_maximum_initial_interval (receiver)</a>. The query interval remains at 200 ms until the initial querying phase reaches 5000 ms, or the <a class="elRef" doxygen="/29W/Amun/home/jenkins/backup_exclude.1/rc/UMQ_6.11.1_RC1/doc/Design/config.tag:../Config/" href="../Config/grpresolveroperation.html#resolverqueryminimuminitialdurationreceiver">resolver_query_minimum_initial_duration (receiver)</a>.</p>
<div class="image">
<img src="Resolver_Initial_Phase_TQR.png" alt="Resolver_Initial_Phase_TQR.png"/>
</div>
 <p>The initial query phase completes when it reaches the <a class="elRef" doxygen="/29W/Amun/home/jenkins/backup_exclude.1/rc/UMQ_6.11.1_RC1/doc/Design/config.tag:../Config/" href="../Config/grpresolveroperation.html#resolverqueryminimuminitialdurationreceiver">resolver_query_minimum_initial_duration (receiver)</a>. The initial query phase also has UM context-wide rate limit controls (<a class="elRef" doxygen="/29W/Amun/home/jenkins/backup_exclude.1/rc/UMQ_6.11.1_RC1/doc/Design/config.tag:../Config/" href="../Config/grpresolveroperation.html#resolverinitialqueriespersecondcontext">resolver_initial_queries_per_second (context)</a> and <a class="elRef" doxygen="/29W/Amun/home/jenkins/backup_exclude.1/rc/UMQ_6.11.1_RC1/doc/Design/config.tag:../Config/" href="../Config/grpresolveroperation.html#resolverinitialquerybpscontext">resolver_initial_query_bps (context)</a>) that can result in the extension of a phase's duration in the case of a large number of topics or long topic names.</p>
<p><br />
 </p>
<h2><a class="anchor" id="sustainingphase"></a>
Sustaining Phase</h2>
<p>The sustaining topic resolution phase follows the initial phase and can be a less active phase in which a new receiver resolves its topic. It can also act as the sole topic resolution phase if you disable the initial phase. The sustaining phase defaults use less network resources than the initial phase and can also be modified or disabled completely. See Disabling Aspects of Topic Resolution in the UM Configuration Guide.</p>
<p><b>Advertising in the Sustaining Phase</b></p>
<p>For the sustaining phase defaults, a source sends an advertisement every second (<a class="elRef" doxygen="/29W/Amun/home/jenkins/backup_exclude.1/rc/UMQ_6.11.1_RC1/doc/Design/config.tag:../Config/" href="../Config/grpresolveroperation.html#resolveradvertisementsustainintervalsource">resolver_advertisement_sustain_interval (source)</a>) for 1 minute (<a class="elRef" doxygen="/29W/Amun/home/jenkins/backup_exclude.1/rc/UMQ_6.11.1_RC1/doc/Design/config.tag:../Config/" href="../Config/grpresolveroperation.html#resolveradvertisementminimumsustaindurationsource">resolver_advertisement_minimum_sustain_duration (source)</a>). When this duration expires, the sustaining phase of advertisement for a topic ends. If a source receives a topic query, the sustaining phase resumes for the topic and the source completes another duration of advertisements.</p>
<div class="image">
<img src="Resolver_Sustain_Phase_TIR.png" alt="Resolver_Sustain_Phase_TIR.png"/>
</div>
 <p>The sustaining advertisement phase has UM context-wide rate limit controls (<a class="elRef" doxygen="/29W/Amun/home/jenkins/backup_exclude.1/rc/UMQ_6.11.1_RC1/doc/Design/config.tag:../Config/" href="../Config/grpresolveroperation.html#resolversustainadvertisementspersecondcontext">resolver_sustain_advertisements_per_second (context)</a> and <a class="elRef" doxygen="/29W/Amun/home/jenkins/backup_exclude.1/rc/UMQ_6.11.1_RC1/doc/Design/config.tag:../Config/" href="../Config/grpresolveroperation.html#resolversustainadvertisementbpscontext">resolver_sustain_advertisement_bps (context)</a>) that can result in the extension of a phase's duration in the case of a large number of topics or long topic names.</p>
<p><b>Querying in the Sustaining Phase</b></p>
<p>Default sustaining phase querying operates the same as advertising. Unresolved receivers query every second (<a class="elRef" doxygen="/29W/Amun/home/jenkins/backup_exclude.1/rc/UMQ_6.11.1_RC1/doc/Design/config.tag:../Config/" href="../Config/grpresolveroperation.html#resolverquerysustainintervalreceiver">resolver_query_sustain_interval (receiver)</a>) for 1 minute (<a class="elRef" doxygen="/29W/Amun/home/jenkins/backup_exclude.1/rc/UMQ_6.11.1_RC1/doc/Design/config.tag:../Config/" href="../Config/grpresolveroperation.html#resolverqueryminimumsustaindurationreceiver">resolver_query_minimum_sustain_duration (receiver)</a>). When this duration expires, the sustaining phase of querying for a topic ends.</p>
<div class="image">
<img src="Resolver_Sustain_Phase_TQR.png" alt="Resolver_Sustain_Phase_TQR.png"/>
</div>
 <p>Sustaining phase queries stop when one of the following events occurs:</p>
<ul>
<li>
The receiver discovers multiple sources that equal <a class="elRef" doxygen="/29W/Amun/home/jenkins/backup_exclude.1/rc/UMQ_6.11.1_RC1/doc/Design/config.tag:../Config/" href="../Config/grpresolveroperation.html#resolutionnumberofsourcesquerythresholdreceiver">resolution_number_of_sources_query_threshold (receiver)</a>. </li>
<li>
The sustaining query phase reaches the <a class="elRef" doxygen="/29W/Amun/home/jenkins/backup_exclude.1/rc/UMQ_6.11.1_RC1/doc/Design/config.tag:../Config/" href="../Config/grpresolveroperation.html#resolverqueryminimumsustaindurationreceiver">resolver_query_minimum_sustain_duration (receiver)</a>. </li>
</ul>
<p>The sustaining query phase also has UM context-wide rate limit controls (<a class="elRef" doxygen="/29W/Amun/home/jenkins/backup_exclude.1/rc/UMQ_6.11.1_RC1/doc/Design/config.tag:../Config/" href="../Config/grpresolveroperation.html#resolversustainqueriespersecondcontext">resolver_sustain_queries_per_second (context)</a> and <a class="elRef" doxygen="/29W/Amun/home/jenkins/backup_exclude.1/rc/UMQ_6.11.1_RC1/doc/Design/config.tag:../Config/" href="../Config/grpresolveroperation.html#resolversustainquerybpscontext">resolver_sustain_query_bps (context)</a>) that can result in the extension of a phase's duration in the case of a large number of topics or long topic names.</p>
<p><br />
 </p>
<h2><a class="anchor" id="quiescentphase"></a>
Quiescent Phase</h2>
<p>This phase is the absence of topic resolution activity for a given topic. It is possible that some topics may be in the quiescent phase at the same time other topics are in initial or sustaining phases of topic resolution.</p>
<p>This phase ends if either of the following occurs.</p>
<ul>
<li>
A new receiver sends a query. </li>
<li>
Your application calls <a class="elRef" doxygen="/29W/Amun/home/jenkins/backup_exclude.1/rc/UMQ_6.11.1_RC1/doc/Design/api.tag:../API/" href="../API/lbm_8h.html#ae6dd7c56acf916ef66658cc1ebc7a525">lbm_context_topic_resolution_request()</a> that provokes the sending of topic queries for any receiver or wildcard receiver in this state. </li>
</ul>
<p><br />
 </p>
<h2><a class="anchor" id="storecontextnameresolution"></a>
Store (context) Name Resolution</h2>
<p>With the UMP/UMQ products, topic resolution facilitates the resolution of Persistent Store names to a DomainID:IPAddress:Port.</p>
<p>Topic Resolution resolves store (or context) names by sending context name queries and context name advertisements over the topic resolution channel. A store name resolves to the store's DomainID:IPAddress:Port. You configure the store's name and IPAddress:Port in the store's XML configuration file. See Identifying Persistent Stores in the <a href="../UME/UM_Guide_for_Persistence=en.pdf">UM Guide for Persistence</a> for more information.</p>
<p>If you do not use UM Routers, the DomainID is zero. Otherwise, the DomainID represents the Topic Resolution Domain where the store resides. Stores can learn their DomainID by listening to Topic Resolution traffic. See the UM Router Guide for more information about Topic Resolution Domains.</p>
<p>Via the Topic Resolution channel, sources query for store names and stores respond with an advertisement when they see a query for their own store name. The advertisement contains the store's DomainID:IPAddress:Port.</p>
<p>For a new source configured to use a store names (<a class="elRef" doxygen="/29W/Amun/home/jenkins/backup_exclude.1/rc/UMQ_6.11.1_RC1/doc/Design/config.tag:../Config/" href="../Config/grpultramessagingpersistence.html#umestorenamesource">ume_store_name (source)</a>), the resolver issues the first context name query as soon as the scheduler can process it. The resolver issues the second advertisement 100 ms later, or at the <a class="elRef" doxygen="/29W/Amun/home/jenkins/backup_exclude.1/rc/UMQ_6.11.1_RC1/doc/Design/config.tag:../Config/" href="../Config/grpresolveroperation.html#resolvercontextnamequeryminimumintervalcontext">resolver_context_name_query_minimum_interval (context)</a>. For each subsequent query, UM doubles the interval between queries. The source sends a query at 200 ms, 400 ms, 800 ms and finally at 1000 ms, or the <a class="elRef" doxygen="/29W/Amun/home/jenkins/backup_exclude.1/rc/UMQ_6.11.1_RC1/doc/Design/config.tag:../Config/" href="../Config/grpresolveroperation.html#resolvercontextnamequerymaximumintervalcontext">resolver_context_name_query_maximum_interval (context)</a>. The interval between queries remains at the maximum 1000 ms until the total time querying for a store (context) name equals <a class="elRef" doxygen="/29W/Amun/home/jenkins/backup_exclude.1/rc/UMQ_6.11.1_RC1/doc/Design/config.tag:../Config/" href="../Config/grpresolveroperation.html#resolvercontextnamequerydurationcontext">resolver_context_name_query_duration (context)</a>. The default for this duration is 0 (zero) which means the resolver continues to send queries until the name resolves. After a store name resolves, the resolver stops sending queries.</p>
<p>If a source sees advertisements from multiple stores with the same name, or a store sees an advertisement that matches its own store name, the source issues a warning log message. The source also issues an informational log message whenever it detects that a resolved store (context) name changes to a different DomainID:IPAddress:Port.</p>
<p><br />
 </p>
<h2><a class="anchor" id="topicresolutionconfigurationoptions"></a>
Topic Resolution Configuration Options</h2>
<p>See the following sections in <a href="../../Config/index.html">UM Configuration Guide</a> for more information"</p>
<ul>
<li>
<a class="elRef" doxygen="/29W/Amun/home/jenkins/backup_exclude.1/rc/UMQ_6.11.1_RC1/doc/Design/config.tag:../Config/" href="../Config/grpresolveroperation.html">Resolver Operation Options</a> </li>
<li>
<a class="elRef" doxygen="/29W/Amun/home/jenkins/backup_exclude.1/rc/UMQ_6.11.1_RC1/doc/Design/config.tag:../Config/" href="../Config/grpmulticastresolvernetwork.html">Multicast Resolver Network Options</a> </li>
<li>
<a class="elRef" doxygen="/29W/Amun/home/jenkins/backup_exclude.1/rc/UMQ_6.11.1_RC1/doc/Design/config.tag:../Config/" href="../Config/grpunicastresolvernetwork.html">Unicast Resolver Network Options</a> </li>
<li>
<a class="elRef" doxygen="/29W/Amun/home/jenkins/backup_exclude.1/rc/UMQ_6.11.1_RC1/doc/Design/config.tag:../Config/" href="../Config/grpwildcardreceiver.html">Wildcard Receiver Options</a> </li>
</ul>
<p><b>Assigning Different Configuration Options to Individual Topics</b></p>
<p>You can assign different configuration option values to individual topics by accessing the topic attribute table (lbm_*_topic_attr_t_stct) before creating the source, receiver or wildcard receiver.</p>
<p>Creating a Source with Different Topic Resolution Options:</p>
<ol>
<li>
Call <a class="elRef" doxygen="/29W/Amun/home/jenkins/backup_exclude.1/rc/UMQ_6.11.1_RC1/doc/Design/api.tag:../API/" href="../API/lbm_8h.html#a96ea052dce2e6376684cbf2003407cbf">lbm_src_topic_attr_setopt()</a> to set new option value </li>
<li>
Call <a class="elRef" doxygen="/29W/Amun/home/jenkins/backup_exclude.1/rc/UMQ_6.11.1_RC1/doc/Design/api.tag:../API/" href="../API/lbm_8h.html#a1ba60407fa2bde0997aab6d5a5d2da1a">lbm_src_topic_alloc()</a> </li>
<li>
Call <a class="elRef" doxygen="/29W/Amun/home/jenkins/backup_exclude.1/rc/UMQ_6.11.1_RC1/doc/Design/api.tag:../API/" href="../API/lbm_8h.html#ab8dd76271bf9df7a5f88476d431f523e">lbm_src_create()</a> </li>
</ol>
<p>Creating a Receiver with Different Topic Resolution Options:</p>
<ol>
<li>
Call <a class="elRef" doxygen="/29W/Amun/home/jenkins/backup_exclude.1/rc/UMQ_6.11.1_RC1/doc/Design/api.tag:../API/" href="../API/lbm_8h.html#a1afc75f0fb3601d072b3463e7acf16a6">lbm_rcv_topic_attr_setopt()</a> to set new option value </li>
<li>
Call <a class="elRef" doxygen="/29W/Amun/home/jenkins/backup_exclude.1/rc/UMQ_6.11.1_RC1/doc/Design/api.tag:../API/" href="../API/lbm_8h.html#a3de8a6a659896f76475c453683db4e18">lbm_rcv_topic_lookup()</a> </li>
<li>
Call <a class="elRef" doxygen="/29W/Amun/home/jenkins/backup_exclude.1/rc/UMQ_6.11.1_RC1/doc/Design/api.tag:../API/" href="../API/lbm_8h.html#aa7491c50fefbc2b70f8035fce7ac1477">lbm_rcv_create()</a> </li>
</ol>
<p>Creating a Wildcard Receiver with Different Topic Resolution Options:</p>
<ol>
<li>
Call <a class="elRef" doxygen="/29W/Amun/home/jenkins/backup_exclude.1/rc/UMQ_6.11.1_RC1/doc/Design/api.tag:../API/" href="../API/lbm_8h.html#acec52fdb461e1f903b319e086d1d3e10">lbm_wildcard_rcv_attr_setopt()</a> to set new wildcard receiver option value </li>
<li>
Call <a class="elRef" doxygen="/29W/Amun/home/jenkins/backup_exclude.1/rc/UMQ_6.11.1_RC1/doc/Design/api.tag:../API/" href="../API/lbm_8h.html#a5b5d52f6b87499213757b73b09bc8160">lbm_wildcard_rcv_create()</a> </li>
</ol>
<p><b>Multicast Network Options</b></p>
<p>Essentially, the _incoming and _outgoing versions of resolver_multicast_address/port provide more fine-grained control of topic resolution. By default, the <a class="elRef" doxygen="/29W/Amun/home/jenkins/backup_exclude.1/rc/UMQ_6.11.1_RC1/doc/Design/config.tag:../Config/" href="../Config/grpmulticastresolvernetwork.html#resolvermulticastaddresscontext">resolver_multicast_address (context)</a> and <a class="elRef" doxygen="/29W/Amun/home/jenkins/backup_exclude.1/rc/UMQ_6.11.1_RC1/doc/Design/config.tag:../Config/" href="../Config/grpmulticastresolvernetwork.html#resolvermulticastportcontext">resolver_multicast_port (context)</a> and the _incoming and _outgoing address and port are set to the same value. If you want your context to listen to a particular multicast address/port and send on another address/port, then you can set the _incoming and _outgoing configuration options to different values.</p>
<p>See <a class="elRef" doxygen="/29W/Amun/home/jenkins/backup_exclude.1/rc/UMQ_6.11.1_RC1/doc/Design/config.tag:../Config/" href="../Config/grpresolveroperation.html">Resolver Operation Options</a> in the <a href="../../Config/index.html">UM Configuration Guide</a> for more information.</p>
<p><br />
 </p>
<h2><a class="anchor" id="unicasttopicresolution"></a>
Unicast Topic Resolution</h2>
<p>By default UM expects multicast connectivity between all sources and receivers. When only unicast connectivity is available, you may configure all sources and receivers to use unicast topic resolution. This requires that you run one or more instances of the UM unicast topic resolution daemon (lbmrd), which perform the same topic resolution activities as multicast topic resolution. You configure your applications to use the lbmrd daemons with <a class="elRef" doxygen="/29W/Amun/home/jenkins/backup_exclude.1/rc/UMQ_6.11.1_RC1/doc/Design/config.tag:../Config/" href="../Config/grpunicastresolvernetwork.html#resolverunicastdaemoncontext">resolver_unicast_daemon (context)</a>.</p>
<p>See <a class="el" href="manpageforlbmrd.html">Manpage for lbmrd</a> for details on running the lbmrd daemon.</p>
<p>The lbmrd can run on any machine, including the source or receiver. Of course, sources will also have to select a transport protocol that uses unicast addressing (e.g. TCP, TCP-LB, or LBT-RU). The lbmrd maintains a table of clients (address and port pairs) from which it has received a topic resolution message, which can be any of the following:</p>
<ul>
<li>
Topic Information Records (TIR) - also known as topic advertisements </li>
<li>
Topic Query Records (TQR) </li>
<li>
keepalive messages, which are only used in unicast topic resolution </li>
</ul>
<p>After lbmrd receives a TQR or TIR, it forwards it to all known clients. If a client (i.e. source or receiver) is not sending either TIRs or TQRs, it sends a keepalive message to lbmrd according to the <a class="elRef" doxygen="/29W/Amun/home/jenkins/backup_exclude.1/rc/UMQ_6.11.1_RC1/doc/Design/config.tag:../Config/" href="../Config/grpresolveroperation.html#resolverunicastkeepaliveintervalcontext">resolver_unicast_keepalive_interval (context)</a>. This registration with the lbmrd allows the client to receive advertisements or queries from lbmrd. lbmrd maintains no state about topics, only about clients.</p>
<dl class="section note"><dt>Note</dt><dd>The Unicast Topic Resolution Daemon (lbmrd) can not run on the OpenVMS platform. If unicast topic resolution is needed with OpenVMS, the lbmrd must be run on an alternate platform (e.g. Linux or Windows).</dd></dl>
<p><b>LBMRD with the UM Router Best Practice</b></p>
<p>If you're using the lbmrd for topic resolution across UM Routers, you may want all of your domains discovered and all routes to be known before creating any topics. If so, change the UM configuration option, <a class="elRef" doxygen="/29W/Amun/home/jenkins/backup_exclude.1/rc/UMQ_6.11.1_RC1/doc/Design/config.tag:../Config/" href="../Config/grpresolveroperation.html#resolverunicastforcealivecontext">resolver_unicast_force_alive (context)</a>, from the default setting to 1 so your contexts start sending keepalives to lbmrd immediately. This makes your startup process cleaner by allowing your contexts to discover the other Topic Resolution Domains and establish the best routes. The trade off is a little more network traffic every 5 seconds.</p>
<p><b>Unicast Topic Information Records</b></p>
<p>Of all topic resolution messages, only the TIR contains address and port information. This tells a receiver how it can get the data being published. Based on the transport type, a receiver can join the appropriate multicast group (for LBT-RM), send a connection request (for LBT-RU), or connect to the source (for TCP).</p>
<p>The address and port information potentially contained within a TIR includes:</p>
<ul>
<li>
For a TCP transport, the source address and TCP port. </li>
<li>
For an LBT-RM transport, the unicast UDP port (to which NAKs are sent) and the UDP destination port. </li>
<li>
For an LBT-RU transport, the source address and UDP port. </li>
</ul>
<p>For unicast-based transports (TCP and LBT-RU), the TIR source address is 0.0.0.0, not the actual source address.</p>
<p>Topic resolution messages (whether received by the application via multicast, or by the unicast topic resolution daemon via unicast) are always UDP datagrams. They are received via a recvfrom() call, which also obtains the address and port from which the datagrams were received. If the address 0.0.0.0 (INADDR_ANY) appears for one of the addresses, lbmrd replaces it with the address from which the datagram is received. The net effect is as if the actual source address had originally been put into the TIR.</p>
<p><b>Unicast Topic Resolution Resilience</b></p>
<p>Running multiple instances of lbmrd allows your applications to continue operation in the face of a lbmrd failure. Your applications' sources and receivers send topic resolution messages as usual, however, rather than sending every message to each lbmrd instance, UM directs messages to lbmrd instances in a round-robin fashion. Since the lbmrd does not maintain any resolver state, as long as one lbmrd instance is running, UM continues to forward LBMR packets to all connected clients. UM switches to the next active lbmrd instance every 250-750 ms.</p>
<p><br />
 </p>
<h2><a class="anchor" id="networkaddresstranslationnat"></a>
Network Address Translation (NAT)</h2>
<p>If your network architecture includes LANs that are bridged with Network Address Translation (NAT), UM receivers will not be able to connect directly to UM sources across the NAT. Sources send Topic Resolution advertisements containing their local IP addresses and ports, but receivers on the other side of the NAT cannot access those sources using those local addresses/ports. They must use alternate addresses/ports, which the NAT forwards according to the NAT's configuration.</p>
<p>The recommended method of establishing UM connectivity across a NAT is to run a pair of UM Routers connected with a single TCP peer link. In this usage, the LANs on each side of the NAT are distinct Topic Resolution Domains.</p>
<p>Alternatively, if the NAT can be configured to allow two-way UDP traffic between the networks, the lbmrd can be configured to modify Topic Resolution advertisements according to a set of rules defined in an XML configuration file. Those rules allow a source's advertisements forwarded to local receivers to be sent as-is, while advertisements forwarded to remote receivers are modified with the IP addresses and ports that the NAT expects. In this usage, the LANs on each side of the NAT are combined into a single Topic Resolution domain.</p>
<dl class="section warning"><dt>Warning</dt><dd>Using an lbmrd NAT configuration severely limits the UM features that can be used across the NAT. Normal source-to-receiver traffic is supported, but the following more-advanced UM features are not supported: <ul>
<li>
<a class="el" href="fundamentalconcepts.html#persistence">Persistence</a> </li>
<li>
<a class="el" href="fundamentalconcepts.html#queuing">Queuing</a> </li>
<li>
<a class="el" href="fundamentalconcepts.html#requestresponse">Request/Response</a> </li>
<li>
<a class="el" href="fundamentalconcepts.html#latejoin">Late Join</a> </li>
<li>
<a class="el" href="umfeatures.html#offtransportrecoveryotr">Off-Transport Recovery (OTR)</a> </li>
<li>
<a class="el" href="umfeatures.html#sendingtosources">Sending to Sources</a> </li>
</ul>
Late Join, sending to sources, and OTR can be made to work if applications are configured to use the default value (0.0.0.0) for <a class="elRef" doxygen="/29W/Amun/home/jenkins/backup_exclude.1/rc/UMQ_6.11.1_RC1/doc/Design/config.tag:../Config/" href="../Config/grprequestnetwork.html#requesttcpinterfacecontext">request_tcp_interface (context)</a>. This means that you cannot use <a class="elRef" doxygen="/29W/Amun/home/jenkins/backup_exclude.1/rc/UMQ_6.11.1_RC1/doc/Design/config.tag:../Config/" href="../Config/grpmajoroptions.html#defaultinterfacecontext">default_interface (context)</a>. Be aware that the UM Router requires a valid interface be specified for <a class="elRef" doxygen="/29W/Amun/home/jenkins/backup_exclude.1/rc/UMQ_6.11.1_RC1/doc/Design/config.tag:../Config/" href="../Config/grprequestnetwork.html#requesttcpinterfacecontext">request_tcp_interface (context)</a>. Thus, <b>lbmrd NAT support for Late Join, Request/Response, and OTR is not compatible with UM topologies that contain the UM Router</b>.</dd></dl>
<p><b>Example NAT configuration</b></p>
<p>In this example, there are two networks, A and B, that are interconnected via a NAT firewall. Network A has IP addresses in the 10.1.0.0/16 range, and B has IP addresses in the 192.168.1/24 range. The NAT is configured such that hosts in network B have no visibility into network A, and can send TCP and UDP packets to only a single host in A (10.1.1.50) via the NAT's external IP address 192.168.1.1, ports 12000 and 12001. I.e. packets sent from B to 192.168.1.1:12000 are forwarded to 10.1.1.50:12000, and packets from B to 192.168.1.1:12001 are forwarded to 10.1.1.50:12001. Hosts in network A have full visibility of network B and can send TCP and UDP packets to hosts in B by their local 192 addresses and ports. Those packets have their source addresses changed to 192.168.1.1.</p>
<p>Since hosts in network A have full visibility into network B, receivers in network A should be able to use source advertisements from network B without any changes. However, receivers in network B will not be able to use source advertisements from network A unless those advertisements' IP addresses are transformed.</p>
<p>The lbmrd is configured for NAT using its XML configuration file:</p>
<pre class="fragment">&lt;?xml version="1.0" encoding="UTF-8" ?&gt;
&lt;lbmrd version="1.0"&gt;
  &lt;daemon&gt;
    &lt;interface&gt;10.1.1.50&lt;/interface&gt;
    &lt;port&gt;12000&lt;/port&gt;
  &lt;/daemon&gt;
  &lt;domains&gt;
    &lt;domain name="DomainA"&gt;
      &lt;network&gt;10.1.0.0/16&lt;/network&gt;
    &lt;/domain&gt;
    &lt;domain name="DomainB"&gt;
      &lt;network&gt;192.168.1/24&lt;/network&gt;
    &lt;/domain&gt;
  &lt;/domains&gt;
  &lt;transformations&gt;
    &lt;transform source="DomainA" destination="DomainB"&gt;
      &lt;rule&gt;
        &lt;match address="10.1.1.50" port="*"/&gt;
        &lt;replace address="192.168.1.1" port="*"/&gt;
      &lt;/rule&gt;
    &lt;/transform&gt;
  &lt;/transformations&gt;
&lt;/lbmrd&gt;
</pre><p>The lbmrd must be run on 10.1.1.50.</p>
<p>The application on 10.1.1.50 should be configured with:</p>
<pre class="fragment">context resolver_unicast_daemon 10.1.1.50:12000
source transport_tcp_port 12001
</pre><p>The applications in the 192 network should be configured with:</p>
<pre class="fragment">context resolver_unicast_daemon 192.168.1.1:12000
source transport_tcp_port 12100
</pre><p>With this, the application on 10.1.1.50 is able to create sources and receivers that communicate with applications in the 192 network.</p>
<p>See <a class="el" href="manpageforlbmrd.html#lbmrdconfigurationfile">lbmrd Configuration File</a> for full details of the XML configuration file.</p>
<p><br />
 </p>
<h1><a class="anchor" id="messagebatching"></a>
Message Batching</h1>
<p>Batching many small messages into fewer network packets decreases the per-message CPU load, thereby increasing throughput. Let's say it costs 2 microseconds of CPU to fully process a message. If you process 10 messages per second, you won't notice the load. If you process half a million messages per second, you saturate the CPU. So to achieve high message rates, you have to reduce the per-message CPU cost with some form of message batching. These per-message costs apply to both the sender and the receiver. However, the implementation of batching is almost exclusively the realm of the sender.</p>
<p>Many people are under the impression that while batching improves CPU load, it increases message latency. While it is true that there are circumstances where this can happen, it is also true that careful use of batching can result in small latency increases or none at all. In fact, there are circumstances where batching can actually reduce latency.</p>
<p>With the UMQ product, you cannot use these message batching features with Brokered Queuing.</p>
<p><br />
 </p>
<h2><a class="anchor" id="implicitbatching"></a>
Implicit Batching</h2>
<p>UM automatically batches smaller messages into transport session datagrams. The implicit batching configuration options, <a class="elRef" doxygen="/29W/Amun/home/jenkins/backup_exclude.1/rc/UMQ_6.11.1_RC1/doc/Design/config.tag:../Config/" href="../Config/grpimplicitbatching.html#implicitbatchingintervalsource">implicit_batching_interval (source)</a> (default = 200 milliseconds) and <a class="elRef" doxygen="/29W/Amun/home/jenkins/backup_exclude.1/rc/UMQ_6.11.1_RC1/doc/Design/config.tag:../Config/" href="../Config/grpimplicitbatching.html#implicitbatchingminimumlengthsource">implicit_batching_minimum_length (source)</a> (default = 2048 bytes) govern UM implicit message batching. Although these are source options, they actually apply to the transport session to which the source was assigned.</p>
<p>See <a class="elRef" doxygen="/29W/Amun/home/jenkins/backup_exclude.1/rc/UMQ_6.11.1_RC1/doc/Design/config.tag:../Config/" href="../Config/grpimplicitbatching.html">Implicit Batching Options</a>.</p>
<p>See also <a class="el" href="umobjects.html#sourceconfigurationandtransportsessions">Source Configuration and Transport Sessions</a>.</p>
<p>UM establishes the implicit batching parameters when it creates the transport session. Any sources assigned to that transport session use the implicit batching limits set for that transport session, and the limits apply to any and all sources subsequently assigned to that transport session. This means that batched transport datagrams can contain messages on multiple topics.</p>
<p><b>Implicit Batching Operation</b></p>
<p>Implicit Batching buffers messages until:</p>
<ul>
<li>
the buffer size exceeds the configured <a class="elRef" doxygen="/29W/Amun/home/jenkins/backup_exclude.1/rc/UMQ_6.11.1_RC1/doc/Design/config.tag:../Config/" href="../Config/grpimplicitbatching.html#implicitbatchingminimumlengthsource">implicit_batching_minimum_length (source)</a> or </li>
<li>
the oldest message in the buffer has been in the buffer for <a class="elRef" doxygen="/29W/Amun/home/jenkins/backup_exclude.1/rc/UMQ_6.11.1_RC1/doc/Design/config.tag:../Config/" href="../Config/grpimplicitbatching.html#implicitbatchingintervalsource">implicit_batching_interval (source)</a> milliseconds. When either condition is met, UM flushes the buffer, pushing the messages onto the network. </li>
</ul>
<p>It may appear this design introduces significant latencies for low-rate topics. However, remember that Implicit Batching operates on a transport session basis. Typically many low-rate topics map to the same transport session, providing a high aggregate rate. The <a class="elRef" doxygen="/29W/Amun/home/jenkins/backup_exclude.1/rc/UMQ_6.11.1_RC1/doc/Design/config.tag:../Config/" href="../Config/grpimplicitbatching.html#implicitbatchingintervalsource">implicit_batching_interval (source)</a> option is a last resort to prevent messages from becoming stuck in the Implicit Batching buffer. If your UM deployment frequently uses the <a class="elRef" doxygen="/29W/Amun/home/jenkins/backup_exclude.1/rc/UMQ_6.11.1_RC1/doc/Design/config.tag:../Config/" href="../Config/grpimplicitbatching.html#implicitbatchingintervalsource">implicit_batching_interval (source)</a> to push out the data (i.e. if the entire transport session has periods of inactivity longer than the value of <a class="elRef" doxygen="/29W/Amun/home/jenkins/backup_exclude.1/rc/UMQ_6.11.1_RC1/doc/Design/config.tag:../Config/" href="../Config/grpimplicitbatching.html#implicitbatchingintervalsource">implicit_batching_interval (source)</a> (defaults to 200 ms), then either the implicit batching options need to be fine-tuned (reducing one or both), or you should consider an alternate form of batching. See <a class="el" href="architecture.html#intelligentbatching">Intelligent Batching</a>.</p>
<p>The minimum value for the <a class="elRef" doxygen="/29W/Amun/home/jenkins/backup_exclude.1/rc/UMQ_6.11.1_RC1/doc/Design/config.tag:../Config/" href="../Config/grpimplicitbatching.html#implicitbatchingintervalsource">implicit_batching_interval (source)</a> is 3 milliseconds. The actual minimum amount of time that data stays in the buffer depends on your Operating System and its scheduling clock interval. For example, on a Solaris 8 machine, the actual time is can be as much as 20 milliseconds. On older Microsoft Windows machines, the time can be as much as 16 milliseconds. On a Linux 2.6 kernel, the actual time is 3 milliseconds (+/- 1).</p>
<p><b>Implicit Batching Example</b></p>
<p>The following example demonstrates how the <a class="elRef" doxygen="/29W/Amun/home/jenkins/backup_exclude.1/rc/UMQ_6.11.1_RC1/doc/Design/config.tag:../Config/" href="../Config/grpimplicitbatching.html#implicitbatchingminimumlengthsource">implicit_batching_minimum_length (source)</a> is actually a trigger or floor, for sending batched messages. It is sometimes misconstrued as a ceiling or upper limit.</p>
<pre class="fragment">implicit_batching_minimum_length = 2000
</pre><ol>
<li>
The first send by your application puts 1900 bytes into the batching buffer, which is below the minimum, so UM holds it. </li>
<li>
The second send fills the batching buffer to 3800 bytes, well over the minimum. UM sends it down to the transport layer, which builds a 3800-byte (plus overhead) datagram and sends it. </li>
<li>
The Operating System fragments the datagram into packets independently of UM and reassembles them on the receiving end. </li>
<li>
UM reads the datagram from the socket at the receiver. </li>
<li>
UM parses out the two messages and delivers them to the appropriate topic levels, which deliver the data. </li>
</ol>
<p>The proper setting of the implicit batching parameters often represents a trade off between latency and efficiency, where efficiency affects the highest throughput attainable. In general, a large minimum length setting increases efficiency and allows a higher peak message rate, but at low message rates a large minimum length can increase latency. A small minimum length can lower latency at low message rates, but does not allow the message rate to reach the same peak levels due to inefficiency. An intelligent use of implicit batching and application-level flushing can be used to implement an adaptive form of batching known as <a class="el" href="architecture.html#intelligentbatching">Intelligent Batching</a> which can provide low latency and high throughput with a single setting.</p>
<p><br />
 </p>
<h2><a class="anchor" id="intelligentbatching"></a>
Intelligent Batching</h2>
<p>Intelligent Batching uses Implicit Batching along with your application's knowledge of the messages it must send. It is a form of dynamic adaptive batching that automatically adjusts for different message rates. Intelligent Batching can provide significant savings of CPU resources without adding any noticeable latency.</p>
<p>For example, your application might receive input events in a batch, and therefore know that it must produce a corresponding batch of output messages. Or the message producer works off of an input queue, and it can detect messages in the queue. In any case, if the application knows that it has more messages to send without going to sleep, it simply does normal sends to UM, letting Implicit Batching send only when the buffer meets the <a class="elRef" doxygen="/29W/Amun/home/jenkins/backup_exclude.1/rc/UMQ_6.11.1_RC1/doc/Design/config.tag:../Config/" href="../Config/grpimplicitbatching.html#implicitbatchingminimumlengthsource">implicit_batching_minimum_length (source)</a> threshold.</p>
<p>However, when the application detects that it has no more messages to send after it sends the current message, it sets the FLUSH flag (LBM_MSG_FLUSH) when sending the message which instructs UM to flush the implicit batching buffer immediately by sending all messages to the transport layer. Refer to <a class="elRef" doxygen="/29W/Amun/home/jenkins/backup_exclude.1/rc/UMQ_6.11.1_RC1/doc/Design/api.tag:../API/" href="../API/lbm_8h.html#a91f4b9cb04fe1323ec56833211cc5cb7">lbm_src_send()</a> in the UM API documentation (UM C API, UM Java API, or UM .NET API) for all the available send flags.</p>
<p>When using Intelligent Batching, it is usually advisable to increase the <a class="elRef" doxygen="/29W/Amun/home/jenkins/backup_exclude.1/rc/UMQ_6.11.1_RC1/doc/Design/config.tag:../Config/" href="../Config/grpimplicitbatching.html#implicitbatchingminimumlengthsource">implicit_batching_minimum_length (source)</a> option to 10 times the size of the average message, to a maximum value of 8196. This tends to strike a good balance between batching length and flushing frequency, giving you low latencies across a wide variation of message rates.</p>
<p><br />
 </p>
<h2><a class="anchor" id="applicationbatching"></a>
Application Batching</h2>
<p>In all of the above situations, your application sends individual messages to UM and lets UM decide when to push the data onto the wire (often with application help). With application batching, your application buffers messages itself and sends a group of messages to UM with a single send. Thus, UM treats the send as a single message. On the receiving side, your application needs to know how to dissect the UM message into individual application messages.</p>
<p>This approach is most useful for Java or .NET applications where there is a higher per-message cost in delivering an UM message to the application. It can also be helpful when using an event queue to deliver received messages. This imposes a thread switch cost for each UM message. At low message rates, this extra overhead is not noticeable. However, at high message rates, application batching can significantly reduce CPU overhead.</p>
<p><br />
 </p>
<h2><a class="anchor" id="explicitbatching"></a>
Explicit Batching</h2>
<p>UM allows you to group messages for a particular topic with explicit batching. The purpose of grouping messages with explicit batching is to allow the receiving application to detect the first and last messages of a group without needing to examine the message contents.</p>
<dl class="section note"><dt>Note</dt><dd>Explicit Batching does not guarantee that all the messages of a group will be sent in a single datagram.</dd></dl>
<dl class="section warning"><dt>Warning</dt><dd>Explicit Batching does not provide any kind of transactional guarantee. It is possible to receive some messages of a group while others are unrecoverably lost. If the first and/or last messages of a group are unrecoverably lost, then the receiving application will not have an indication of start and/or end of the group.</dd></dl>
<p>When your application sends a message (<a class="elRef" doxygen="/29W/Amun/home/jenkins/backup_exclude.1/rc/UMQ_6.11.1_RC1/doc/Design/api.tag:../API/" href="../API/lbm_8h.html#a91f4b9cb04fe1323ec56833211cc5cb7">lbm_src_send()</a>) it may flag the message as being the start of a batch (LBM_MSG_START_BATCH) or the end of a batch (LBM_MSG_END_BATCH). All messages sent between the start and end are grouped together. The flag used to indicate the end of a batch also signals UM to send the message immediately to the implicit batching buffer. At this point, <a class="el" href="architecture.html#implicitbatching">Implicit Batching</a> completes the batching operation. UM includes the start and end flags in the message so receivers can process the batched messages effectively.</p>
<p>Unlike Intelligent Batching which allows intermediate messages to trigger flushing according to the <a class="elRef" doxygen="/29W/Amun/home/jenkins/backup_exclude.1/rc/UMQ_6.11.1_RC1/doc/Design/config.tag:../Config/" href="../Config/grpimplicitbatching.html#implicitbatchingminimumlengthsource">implicit_batching_minimum_length (source)</a> option, explicit batching holds all messages until the batch is completed. This feature is useful if you configure a relatively small <a class="elRef" doxygen="/29W/Amun/home/jenkins/backup_exclude.1/rc/UMQ_6.11.1_RC1/doc/Design/config.tag:../Config/" href="../Config/grpimplicitbatching.html#implicitbatchingminimumlengthsource">implicit_batching_minimum_length (source)</a> and your application has a batch of messages to send that exceeds the <a class="elRef" doxygen="/29W/Amun/home/jenkins/backup_exclude.1/rc/UMQ_6.11.1_RC1/doc/Design/config.tag:../Config/" href="../Config/grpimplicitbatching.html#implicitbatchingminimumlengthsource">implicit_batching_minimum_length (source)</a>. By releasing all the messages at once, Implicit Batching maximizes the size of the network datagrams.</p>
<p><b>Explicit Batching Example</b></p>
<p>The following example demonstrates explicit batching.</p>
<pre class="fragment">implicit_batching_minimum_length = 8000
</pre><ol>
<li>
Your application performs 10 sends of 100 bytes each as a single explicit batch. </li>
<li>
At the 10th send (which completes the batch), UM delivers the 1000 bytes of messages to the implicit batch buffer. </li>
<li>
Let's assume that the buffer already has 7899 bytes of data in it from other topics on the same transport session </li>
<li>
UM adds the first 100-byte message to the buffer, bringing it to 7999. </li>
<li>
UM adds the second 100-byte message, bringing it up to 8099 bytes, which exceeds </li>
<li>
licit_batching_minimum_length but is below the 8192 maximum datagram size. </li>
<li>
UM sends the 8099 bytes (plus overhead) datagram. </li>
<li>
UM adds the third through tenth messages to the implicit batch buffer. These messages will be sent when either <a class="elRef" doxygen="/29W/Amun/home/jenkins/backup_exclude.1/rc/UMQ_6.11.1_RC1/doc/Design/config.tag:../Config/" href="../Config/grpimplicitbatching.html#implicitbatchingminimumlengthsource">implicit_batching_minimum_length (source)</a> is again exceeded, or the <a class="elRef" doxygen="/29W/Amun/home/jenkins/backup_exclude.1/rc/UMQ_6.11.1_RC1/doc/Design/config.tag:../Config/" href="../Config/grpimplicitbatching.html#implicitbatchingintervalsource">implicit_batching_interval (source)</a> is met, or a message arrives in the buffer with the flush flag (LBM_MSG_FLUSH) set. </li>
</ol>
<p><br />
 </p>
<h2><a class="anchor" id="adaptivebatching"></a>
Adaptive Batching</h2>
<p>The adaptive batching feature is deprecated and will be removed from the product in a future release.</p>
<p><br />
 </p>
<h1><a class="anchor" id="ordereddelivery"></a>
Ordered Delivery</h1>
<p>With the Ordered Delivery feature, a receiver's delivery controller can deliver messages to your application in sequence number order or arrival order. This feature can also reassemble fragmented messages or leave reassembly to the application. You can set Ordered Delivery via UM configuration option to one of three modes:</p>
<ul>
<li>
Sequence Number Order, Fragments Reassembled </li>
<li>
Arrival Order, Fragments Reassembled </li>
<li>
Arrival Order, Fragments Not Reassembled </li>
</ul>
<p><br />
 </p>
<h2><a class="anchor" id="sequencenumberorderfragmentsreassembleddefaultmode"></a>
Sequence Number Order, Fragments Reassembled (Default Mode)</h2>
<p>In this mode, a receiver's delivery controller delivers messages in sequence number order (the same order in which they are sent). This feature also guarantees reassembly of fragmented large messages. To enable sequence number ordered delivery, set the <a class="elRef" doxygen="/29W/Amun/home/jenkins/backup_exclude.1/rc/UMQ_6.11.1_RC1/doc/Design/config.tag:../Config/" href="../Config/grpmajoroptions.html#ordereddeliveryreceiver">ordered_delivery (receiver)</a> configuration option as shown:</p>
<pre class="fragment">receiver ordered_delivery 1
</pre><p>Please note that ordered delivery can introduce latency when packets are lost (new messages are buffered waiting for retransmission of lost packets).</p>
<p><br />
 </p>
<h2><a class="anchor" id="arrivalorderfragmentsreassembled"></a>
Arrival Order, Fragments Reassembled</h2>
<p>This mode delivers messages immediately upon reception, in the order the datagrams are received, except for fragmented messages, which UM holds and reassembles before delivering to your application. Be aware that messages can be delivered out of order, either because of message loss and retransmission, or because the networking hardware re-orders UDP packets. Your application can then use the sequence_number field of lbm_msg_t objects to order or discard messages.</p>
<p>To enable this arrival-order-with-reassembly mode, set the following configuration option as shown:</p>
<pre class="fragment">receiver ordered_delivery -1
</pre><p><br />
 </p>
<h2><a class="anchor" id="arrivalorderfragmentsnotreassembled"></a>
Arrival Order, Fragments Not Reassembled</h2>
<p>This mode allows messages to be delivered to the application immediately upon reception, in the order the datagrams are received. If a message is lost, UM will retransmit the message. In the meantime, any subsequent messages received are delivered immediately to the application, followed by the dropped packet when its retransmission is received. This mode guarantees the lowest latency.</p>
<p>With this mode, the receiver delivers messages larger than the transport's maximum datagram size as individual fragments. (See transport_*_datagram_max_size in the <a href="../Config/index.html">UM Configuration Guide</a>.) The C API function, <a class="elRef" doxygen="/29W/Amun/home/jenkins/backup_exclude.1/rc/UMQ_6.11.1_RC1/doc/Design/api.tag:../API/" href="../API/lbm_8h.html#afa760960c21f502a8cb4c5ec5d97f91b">lbm_msg_retrieve_fragment_info()</a> returns fragmentation information for the message you pass to it, and can be used to reassemble large messages. (In Java and .NET, LBMMessage provides methods to return the same fragment information.) Note that reassembly is not required for small messages.</p>
<p>To enable this no-reassemble arrival-order mode, set the following configuration option as shown:</p>
<pre class="fragment">receiver ordered_delivery 0
</pre><p>When developing message reassembly code, consider the following:</p>
<ul>
<li>
Message fragments don't necessarily arrive in sequence number order. </li>
<li>
Some message fragments may never arrive (unrecoverable loss), so you must time out partial messages. </li>
</ul>
<p><br />
 </p>
<h1><a class="anchor" id="lossdetectionusingtsnis"></a>
Loss Detection Using TSNIs</h1>
<p>When a source enters a period during which it has no data traffic to send, that source issues timed Topic Sequence Number Info (TSNI) messages. The TSNI lets receivers know that the source is still active and also reminds receivers of the sequence number of the last message. This helps receivers become aware of any lost messages between TSNIs.</p>
<p>Sources send TSNIs over the same transport and on the same topic as normal data messages. You can set a time value of the TSNI interval with configuration option <a class="elRef" doxygen="/29W/Amun/home/jenkins/backup_exclude.1/rc/UMQ_6.11.1_RC1/doc/Design/config.tag:../Config/" href="../Config/grpmajoroptions.html#transporttopicsequencenumberinfointervalsource">transport_topic_sequence_number_info_interval (source)</a>. You can also set a time value for the duration that the source sends contiguous TSNIs with configuration option <a class="elRef" doxygen="/29W/Amun/home/jenkins/backup_exclude.1/rc/UMQ_6.11.1_RC1/doc/Design/config.tag:../Config/" href="../Config/grpmajoroptions.html#transporttopicsequencenumberinfoactivethresholdsource">transport_topic_sequence_number_info_active_threshold (source)</a>, after which time the source stops issuing TSNIs.</p>
<p><br />
 </p>
<h1><a class="anchor" id="receiverkeepaliveusingsesssionmessages"></a>
Receiver Keepalive Using Session Messages</h1>
<p>When an LBT-RM, LBT-RU, or LBT-IPC transport session enters a period during which it has no data traffic to send, UM issues timed Session Messages (SMs). For example, suppose all topics in a session stop sending data. One by one, they then send TSNIs, and if there is still no data to send, their TSNI periods eventually expire. After the last quiescent topic's TSNIs stop, UM begins transmitting SMs.</p>
<p>You can set time values for SM interval and duration with configuration options specific to their transport type.</p>
<div class="image">
<img src="SMs.png" alt="SMs.png"/>
</div>
  </div></div><!-- contents -->
</div><!-- doc-content -->
<!-- HTML footer for doxygen 1.8.11-->
</body>
</html>
