<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.11"/>
<title>Guide for Persistence: Store Thread Affinity</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
  $(window).load(resizeHeight);
</script>
<link href="doxygen_manual.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Guide for Persistence
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.11 -->
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('storethreadaffinity.html','');});
</script>
<div id="doc-content">
<div class="header">
  <div class="headertitle">
<div class="title">Store Thread Affinity </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>A significant performance improvement of the Store can be obtained by "pinning" threads to CPU cores. Normally, the operating system will migrate a process's threads to different CPU cores, depending on what else is going on in the host. This can degrade the process's performance in a number of ways, mostly related to memory access (cache, NUMA zones). By setting the CPU affinity for the performance-sensitive threads, you avoid this degradation.</p>
<p>For high-throughput applications, you will gain significant performance improvement by constraining the operating system to run the Store's threads on specific CPU cores. All of a Store's threads should run on cores in the same physical CPU chip.</p>
<p>For maximum benefit, you should "isolate" the cores running the message reception threads. This prevents the operating system from scheduling other processes/threads on those cores.</p>
<p><b>Setting Affinity</b></p>
<p>When the Store Process is executed, the user can optionally use the "-a" option to set CPU affinity to the various threads. See <a class="el" href="manpagesforstore.html#umestoredmanpage">Umestored Man Page</a>.</p>
<p>Note that for the Windows Service, you don't supply the option when the service is run. Instead you save the thread affinity into the Windows registry for subsequent use by the Store Windows Service. See <a class="el" href="manpagesforstore.html#umestoredsmanpage">Umestoreds Man Page</a> and <a class="elRef" doxygen="/29W/Amun/home/sford/backup_exclude/labbox/sfordmac_DEV_HF_6_14/29West/lbm/doc/UME/operations.tag:../Operations/" href="../Operations/startupshutdownprocedures.html#configurethewindowsservice">Configure the Windows Service</a>.</p>
<p>The "-a" option takes a comma-separate list of CPU (core) numbers. For example, "-a 1,3,1,..." refers to CPU 1, CPU 3, CPU 1 again, etc.</p>
<p>The sequence of numbers are assigned to threads as follows:</p>
<p>The first number is the "process" CPU number, which is used for all miscellaneous threads that aren't otherwise assigned.</p>
<p>The next 4 numbers are assigned to a Store's operational threads in the following sequence: </p><ol>
<li>
Message reception thread. </li>
<li>
Proxy source thread. </li>
<li>
Receiver recovery thread. </li>
<li>
Auxiliary thread. </li>
</ol>
<p>If the Store Process has multiple Stores configured, additional groups of 4 numbers should be supplied.</p>
<p>Of these threads, the most critical is the message reception thread. For best performance, each Store's message reception thread should be given exclusive access to its own CPU core.</p>
<p>The receiver recovery thread is also important, since it can affect the speed at which receivers can recover missed messages. However, since CPU cores are scarce resources on hosts, it may not be practical to give each receiver recovery thread its own core.</p>
<p>The proxy source and auxiliary threads are not critical to general Store throughput, and are therefore generally assigned to the "process" core as miscellaneous.</p>
<p><b>Affinity Example</b></p>
<p>For example, suppose you have a Store Process configured for two Stores. Further, let's say that on your host, even-numbered CPUs belong to one physical CPU chip, and odd-numbered CPUs belong to a different physical CPU chip. The following would optimize both message reception and message recovery, at the expense of consuming 5 cores:</p>
<pre class="fragment">umestored -a 3,5,3,7,3,9,3,11,3 ...
</pre><p>This assigns: </p><ul>
<li>
the process's miscellaneous threads to CPU 3, </li>
<li>
the first Store's message reception thread to CPU 5, </li>
<li>
the first Store's proxy source thread to CPU 3, </li>
<li>
the first Store's receiver recovery thread to CPU 7, </li>
<li>
the first Store's auxiliary thread to CPU 3, </li>
<li>
the second Store's message reception thread to CPU 9, </li>
<li>
the second Store's proxy source thread to CPU 3, </li>
<li>
the second Store's receiver recovery thread to CPU 11, </li>
<li>
the second Store's auxiliary thread to CPU 3. </li>
</ul>
<p>If assigning this many cores to the Store Process is not practical, the following conserves cores at the expense of potentially degrading message recovery speed:</p>
<pre class="fragment">umestored -a 3,5,3,3,3,7,3,3,3 ...
</pre><p>This assigns a CPU core to each of the two message reception threads (5 and 7), and groups all other threads onto the miscellaneous CPU core (3).</p>
<p><br />
<br />
 <br />
 <br />
 <br />
 <br />
 <br />
 <br />
 <br />
 <br />
 <br />
 <br />
 <br />
 <br />
 <br />
 <br />
 <br />
 <br />
 <br />
 <br />
 <br />
 <br />
 <br />
 <br />
 <br />
 <br />
 <br />
 <br />
 <br />
 <br />
 <br />
 <br />
 <br />
 <br />
 <br />
 <br />
 <br />
 <br />
 <br />
 <br />
 <br />
</p>
</div></div><!-- contents -->
</div><!-- doc-content -->
<!-- HTML footer for doxygen 1.8.11-->
</body>
</html>
