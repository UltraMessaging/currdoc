<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.11"/>
<title>Guide for Persistence: Special Configuration Topics</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
  $(window).load(resizeHeight);
</script>
<link href="doxygen_manual.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Guide for Persistence
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.11 -->
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('specialconfigurationtopics.html','');});
</script>
<div id="doc-content">
<div class="header">
  <div class="headertitle">
<div class="title">Special Configuration Topics </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p><br />
 </p>
<h1><a class="anchor" id="storelossrepair"></a>
Store Loss Repair&nbsp;&nbsp;<small><a href="#storelossrepair">&lt;-</a></small></h1>
<p>The persistent Store uses a normal UM receiver to get messages from the source. The Store is subject to the same potential <a class="elRef" doxygen="/29W/Amun/home/sford/backup_exclude/labbox/sfordw_DEV_HF_6_16/29West/lbm/doc/UME/design.tag:../Design/" href="../Design/packetloss.html">Packet Loss</a> scenarios as an application subscriber, and uses the same loss repair techniques as a subscriber.</p>
<p>Informatica recommends enabling <a class="elRef" doxygen="/29W/Amun/home/sford/backup_exclude/labbox/sfordw_DEV_HF_6_16/29West/lbm/doc/UME/design.tag:../Design/" href="../Design/umfeatures.html#offtransportrecoveryotr">Off-Transport Recovery (OTR)</a> on the Store and application subscribers.</p>
<p><br />
 </p>
<h1><a class="anchor" id="persistencebuffersizes"></a>
Persistence Buffer Sizes&nbsp;&nbsp;<small><a href="#persistencebuffersizes">&lt;-</a></small></h1>
<p>There are two memory buffers that need to be properly sized to get the desired level of performance and reliability for persistence: </p><ul>
<li>
Source retention buffer, also known as the late join buffer. </li>
<li>
Store message cache. </li>
</ul>
<p>This analysis assumes that you are using disk-based Stores.</p>
<p>The sizing depends on how sensitive your publishing application is to being slowed down in the event of packet loss. The Stores are designed to write messages to disk in sequence-number order. So in the event of packet loss, newly received messages must be buffered in the Store's message cache while the Store waits for retransmission of the lost messages. If the source's message rate is high and the time required to repair the packet loss is significant, the Store's cache must be configured to be large.</p>
<p>Note that this affects the flight size configuration also. For SPP Stores, message stability is acknowledged to the source after the messages is successfully written to disk. But for messages being kept in the Store's message cache waiting for lost packet retransmission, stability acknowledgement is delayed. All messages sent during this time are said to be "in flight". To avoid the publisher being blocked on flight size, the flight size limit might need to be made large. It is not unusual for our performance-sensitive users to configure the flight size limit to be in the tens of thousands.</p>
<p>Finally, the source's retention buffer (late join buffer) should be sized the same as the flight size limit.</p>
<p><br />
 </p>
<h1><a class="anchor" id="calculatingoptionsforspp"></a>
Calculating Options for SPP&nbsp;&nbsp;<small><a href="#calculatingoptionsforspp">&lt;-</a></small></h1>
<p>Determine the following for your application: </p><ul>
<li>
avg_msg_size - The source's average size of application messages, in bytes. </li>
<li>
avg_msg_rate - The source's average message send rate, in datagrams per second. </li>
</ul>
<p>The following formulas calculate minimum recommended values of some configuration options: </p><pre class="fragment">ume_flight_size = 3 * (ume_ack_batching_interval/1,000) * avg_msg_rate
ume_flight_size_bytes = ume_flight_size * avg_msg_size
ume_repository_size_threshold = ume_flight_size_bytes
ume_repository_size_limit = 1.2 * ume_repository_size_threshold
</pre><p>If <a class="el" href="optionsforastoresumeattributeselement.html#umecfgstabilityackminimumnumber">Topic Option "stability-ack-minimum-number"</a> is greater than 1, the value of <a class="el" href="optionsforastoresumeattributeselement.html#umecfgstabilityackinterval">Topic Option "stability-ack-interval"</a> needs to be added in as follows: </p><pre class="fragment">ume_flight_size = 3 * ((ume_ack_batching_interval + stability-ack-interval)/1,000)
                  * avg_msg_rate
</pre><p> The other parameters must then be recalculated.</p>
<p>For example: </p><pre class="fragment">avg_msg_size = 1024 bytes            (hypothetical use case)
avg_msg_rate = 10,000 datagrams/sec  (hypothetical use case)

ume_flight_size = 3 * (100/1000) * 10000 = 3000
ume_flight_size_bytes = 3000 * 1024 = 3,072,000
ume_repository_size_threshold = 3,072,000
ume_repository_size_limit = 1.2 * 3072000 = 3,686,400
</pre><p>Note that application deviations (e.g. bursts) from the averages can result in unexpected disk writes and blocking imposed on the source. To reduce the chances of blocking, the values for avg_msg_size and/or avg_msg_rate can be increased (with the subsequent configuration values recalculated).</p>
<p><br />
 </p>
<h1><a class="anchor" id="rppconfigurationspecifics"></a>
RPP Configuration Specifics&nbsp;&nbsp;<small><a href="#rppconfigurationspecifics">&lt;-</a></small></h1>
<p>With RPP, there is a non-obvious interaction between the settings for: </p><ul>
<li>
Store configuration option <a class="el" href="optionsforastoresumeattributeselement.html#umecfgrepositorysizelimit">repository-size-limit</a>, </li>
<li>
Store configuration option <a class="el" href="optionsforastoresumeattributeselement.html#umecfgrepositorysizethreshold">repository-size-threshold</a> </li>
<li>
Store configuration option <a class="el" href="optionsforastoresumeattributeselement.html#umecfgrepositorydiskwritedelay">repository-disk-write-delay</a>, </li>
<li>
Source LBM configuration option <a class="elRef" doxygen="/29W/Amun/home/sford/backup_exclude/labbox/sfordw_DEV_HF_6_16/29West/lbm/doc/UME/config.tag:../Config/" href="../Config/grpultramessagingpersistence.html#umerepositoryackonreceptionsource">ume_repository_ack_on_reception (source)</a>, </li>
<li>
Source LBM configuration options <a class="elRef" doxygen="/29W/Amun/home/sford/backup_exclude/labbox/sfordw_DEV_HF_6_16/29West/lbm/doc/UME/config.tag:../Config/" href="../Config/grpultramessagingpersistence.html#umeflightsizebytessource">ume_flight_size_bytes (source)</a> and <a class="elRef" doxygen="/29W/Amun/home/sford/backup_exclude/labbox/sfordw_DEV_HF_6_16/29West/lbm/doc/UME/config.tag:../Config/" href="../Config/grpultramessagingpersistence.html#umeflightsizesource">ume_flight_size (source)</a>. </li>
<li>
Receiver LBM configuration option <a class="elRef" doxygen="/29W/Amun/home/sford/backup_exclude/labbox/sfordw_DEV_HF_6_16/29West/lbm/doc/UME/config.tag:../Config/" href="../Config/grpultramessagingpersistence.html#umeackbatchingintervalcontext">ume_ack_batching_interval (context)</a>. </li>
<li>
Store LBM configuration options <a class="el" href="optionsforastoresumeattributeselement.html#umecfgstabilityackinterval">stability-ack-interval</a> and <a class="el" href="optionsforastoresumeattributeselement.html#umecfgstabilityackminimumnumber">stability-ack-minimum-number</a>. </li>
</ul>
<p>The source and Store can enter a state where the sending rate is severely limited by flight size, even though the Store is relatively idle.</p>
<p>To avoid this issue, you need to analyze your usage patterns and set your configuration options appropriately. Determine the following for your application: </p><ul>
<li>
avg_msg_size - The source's average size of application messages, in bytes. </li>
<li>
avg_msg_rate - The source's average message send rate, in datagrams per second. </li>
</ul>
<p>Next you need to decide how long you want to set <a class="el" href="optionsforastoresumeattributeselement.html#umecfgrepositorydiskwritedelay">repository-disk-write-delay</a>. The idea is that you want to avoid writing to disk during normal operation, so you should set it long enough that all normally-operating receivers have a chance to acknowledge consumption of the messages during the write delay time. Remember that when a receiver gets a message, it might delay sending consumption for <a class="elRef" doxygen="/29W/Amun/home/sford/backup_exclude/labbox/sfordw_DEV_HF_6_16/29West/lbm/doc/UME/config.tag:../Config/" href="../Config/grpultramessagingpersistence.html#umeackbatchingintervalcontext">ume_ack_batching_interval (context)</a> milliseconds (defaults to 100).</p>
<p>You also need to take into account heavy bursts of traffic, where receivers might store significant numbers of messages in their socket buffers, and it can take time for the receivers to work their way through all of them.</p>
<p>But you don't want to make the repository-disk-write-delay larger than necessary because it can lead to very high memory usage in the Store. We generally see repository-disk-write-delay being set to values as low as 1000 (1 sec) and as high as 5000 (5 sec).</p>
<p>The following formulas calculate minimum recommended values of some configuration options: </p><pre class="fragment">ume_flight_size = 3 * (ume_ack_batching_interval/1,000) * avg_msg_rate
ume_flight_size_bytes = ume_flight_size * avg_msg_size
ume_repository_size_threshold =
        (avg_msg_size * avg_msg_rate * (repository-disk-write-delay/1,000))
        + ume_flight_size_bytes
ume_repository_size_limit = 1.2 * ume_repository_size_threshold
</pre><p> If <a class="el" href="optionsforastoresumeattributeselement.html#umecfgstabilityackminimumnumber">Topic Option "stability-ack-minimum-number"</a> is greater than 1, the value of <a class="el" href="optionsforastoresumeattributeselement.html#umecfgstabilityackinterval">Topic Option "stability-ack-interval"</a> needs to be added in as follows: </p><pre class="fragment">ume_flight_size = 3 * ((ume_ack_batching_interval + stability-ack-interval)/1,000)
                  * avg_msg_rate
</pre><p> The other parameters must then be recalculated.</p>
<p>For example: </p><pre class="fragment">avg_msg_size = 1024 bytes            (hypothetical use case)
avg_msg_rate = 10,000 datagrams/sec  (hypothetical use case)
repository-disk-write-delay = 2500  (2.5 sec, chosen by user)

ume_flight_size = 3 * (100/1000) * 10000 = 3000
ume_flight_size_bytes = 3000 * 1024 = 3,072,000
ume_repository_size_threshold = (1024 * 10000 * (2500/1000)) + 3072000 = 28,672,000
ume_repository_size_limit = 1.2 * 28672000 = 34,406,400
</pre><p>Note that application deviations (e.g. bursts) from the averages can result in unexpected disk writes and blocking imposed on the source. To reduce the chances of blocking, the values for avg_msg_size and/or avg_msg_rate can be increased (with the subsequent configuration values recalculated).</p>
<p><br />
<br />
 <br />
 <br />
 <br />
 <br />
 <br />
 <br />
 <br />
 <br />
 <br />
 <br />
 <br />
 <br />
 <br />
 <br />
 <br />
 <br />
 <br />
 <br />
 <br />
 <br />
 <br />
 <br />
 <br />
 <br />
 <br />
 <br />
 <br />
 <br />
 <br />
 <br />
 <br />
 <br />
 <br />
 <br />
 <br />
 <br />
 <br />
 <br />
 <br />
</p>
</div></div><!-- contents -->
</div><!-- doc-content -->
<!-- HTML footer for doxygen 1.8.11-->
</body>
</html>
